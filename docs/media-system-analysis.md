# Анализ системы медиафайлов: недостатки и план улучшений

**Дата анализа**: 2025-11-15  
**Версия системы**: текущая (по документации media-system.md)

---

## Критические недостатки

### 1. Дедупликация не реализована

**Проблема**:  
- `checksum_sha256` вычисляется и сохраняется в БД (`MediaStoreAction@checksum`)
- Индекс на `checksum_sha256` создан в миграции
- Но при загрузке не проверяется существование файла с таким же checksum
- Результат: дубликаты файлов занимают место на диске

**Где**: `app/Domain/Media/Actions/MediaStoreAction.php:53,69`

**Решение**:  
- Перед сохранением проверять `Media::where('checksum_sha256', $checksum)->first()`
- Если найден → вернуть существующую запись вместо создания новой
- Опционально: добавить поле `usage_count` для отслеживания ссылок

---

### 2. Физические файлы вариантов не удаляются

**Проблема**:  
- При удалении `Media` варианты удаляются из БД каскадно (`cascadeOnDelete`)
- Но физические файлы вариантов остаются на диске
- Результат: накопление orphaned файлов

**Где**: `database/migrations/2025_11_06_000041_create_media_variants_table.php:12`  
**Где**: `app/Http/Controllers/Admin/V1/MediaController.php:504` (нет удаления файлов)

**Решение**:  
- Добавить `deleting` event в модель `Media`
- В событии удалять все файлы вариантов через `Storage::disk($media->disk)->delete($variant->path)`
- Также удалять оригинальный файл при soft delete (или только при force delete)

---

### 3. Генерация вариантов блокирует запросы

**Проблема**:  
- `OnDemandVariantService@ensureVariant` вызывает `GenerateVariantJob::dispatchSync()`
- Синхронная генерация блокирует HTTP-запрос
- Для больших изображений это может занять несколько секунд

**Где**: `app/Domain/Media/Services/OnDemandVariantService.php:46`

**Решение**:  
- По умолчанию использовать асинхронную генерацию (`dispatch()`)
- Для критичных случаев (первый preview) — синхронно, но с таймаутом
- Добавить конфиг `media.variant_generation_mode: 'sync'|'async'|'hybrid'`

---

### 4. Нет извлечения длительности видео/аудио

**Проблема**:  
- В документации указано: "Для видео/аудио: длительность (не реализовано)"
- `MediaMetadataExtractor@extract` всегда возвращает `duration_ms => null`
- Результат: неполные метаданные для медиа

**Где**: `app/Domain/Media/Services/MediaMetadataExtractor.php:35,54`

**Решение**:  
- Использовать `getid3/getid3` или `ffprobe` для извлечения длительности
- Добавить опциональную зависимость в `composer.json`
- Обрабатывать ошибки gracefully (если библиотека недоступна)

---

## Важные недостатки

### 5. Нет валидации существования файла на диске

**Проблема**:  
- При запросе preview/download не проверяется существование файла
- Может быть рассинхронизация БД и файловой системы
- Результат: 500 ошибки при попытке отдать несуществующий файл

**Где**: `app/Http/Controllers/Admin/V1/MediaPreviewController.php:155,237`

**Решение**:  
- Проверять `Storage::disk($media->disk)->exists($path)` перед отдачей
- Если файл отсутствует → 404 или регенерация варианта
- Добавить команду `php artisan media:verify` для проверки всех файлов

---

### 6. Нет очистки orphaned файлов

**Проблема**:  
- Файлы могут остаться на диске после удаления записей из БД
- Нет механизма автоматической очистки
- Результат: накопление мусора на диске

**Решение**:  
- Создать команду `php artisan media:cleanup-orphaned`
- Сравнивать файлы на диске с записями в БД
- Удалять файлы без записей (с подтверждением)

---

### 7. Нет оптимизации изображений при загрузке

**Проблема**:  
- Изображения сохраняются как есть, без сжатия
- Нет конвертации в WebP для лучшей производительности
- Результат: большие размеры файлов, медленная загрузка

**Решение**:  
- Добавить опциональную оптимизацию через `spatie/image-optimizer` или `intervention/image`
- Конфиг: `media.optimize_on_upload: true/false`
- Качество JPEG: `media.jpeg_quality: 85`

---

### 8. Нет batch загрузки

**Проблема**:  
- Можно загрузить только один файл за запрос
- Для множественной загрузки нужно делать много запросов
- Результат: неудобство для пользователей

**Решение**:  
- Добавить endpoint `POST /api/v1/admin/media/batch`
- Принимать массив файлов `files[]`
- Возвращать массив созданных `Media` ресурсов

---

### 9. Нет кэширования метаданных

**Проблема**:  
- Метаданные извлекаются каждый раз при загрузке
- EXIF данные читаются заново
- Результат: избыточная нагрузка на CPU

**Решение**:  
- Метаданные уже сохраняются в БД (`width`, `height`, `exif_json`)
- Проблема актуальна только при повторной обработке
- Добавить кэш для часто запрашиваемых метаданных (если нужно)

---

### 10. Нет поддержки прогресса загрузки

**Проблема**:  
- Нет chunked upload для больших файлов
- Нет индикации прогресса
- Результат: таймауты при загрузке больших файлов

**Решение**:  
- Реализовать resumable upload (Tus protocol или custom)
- Или увеличить `upload_max_filesize` и `post_max_size`
- Добавить endpoint для проверки статуса загрузки

---

### 11. Нет версионирования файлов

**Проблема**:  
- При замене файла старая версия теряется
- Нет истории изменений
- Результат: невозможность отката

**Решение**:  
- Добавить таблицу `media_versions` для хранения истории
- При обновлении создавать новую версию вместо замены
- Endpoint `GET /api/v1/admin/media/{media}/versions`

---

## Улучшения производительности

### 12. Нет CDN invalidation

**Проблема**:  
- При изменении вариантов старые версии остаются в CDN кэше
- Нет механизма инвалидации
- Результат: устаревший контент в CDN

**Решение**:  
- Интеграция с CloudFront/Cloudflare API
- Автоматическая инвалидация при генерации вариантов
- Конфиг: `media.cdn_invalidation_enabled: true/false`

---

### 13. Нет watermarking

**Проблема**:  
- Нет возможности автоматически добавлять водяные знаки
- Нужно обрабатывать изображения вручную
- Результат: неудобство для защиты контента

**Решение**:  
- Добавить опциональный watermark при генерации вариантов
- Конфиг: `media.watermark.enabled`, `media.watermark.path`, `media.watermark.position`
- Применять только к публичным вариантам

---

### 14. Нет метрик и статистики

**Проблема**:  
- Нет информации об использовании медиа
- Нет статистики по размерам, типам файлов
- Результат: сложность мониторинга

**Решение**:  
- Endpoint `GET /api/v1/admin/media/stats`
- Статистика: общий размер, количество по типам, топ используемых медиа
- Интеграция с системой аналитики

---

## План улучшений (приоритеты)

### Фаза 1: Критичные исправления (1-2 недели)

1. ✅ **Дедупликация файлов** (критично)
   - Проверка checksum перед сохранением
   - Возврат существующей записи или создание новой
   - Тесты на дедупликацию

2. ✅ **Удаление физических файлов** (критично)
   - Event `deleting` в модели `Media`
   - Удаление файлов вариантов и оригинала
   - Тесты на cleanup

3. ✅ **Валидация существования файлов** (важно)
   - Проверка перед отдачей файла
   - Обработка отсутствующих файлов
   - Команда `media:verify`

---

### Фаза 2: Производительность (2-3 недели)

4. ✅ **Асинхронная генерация вариантов**
   - Конфиг режима генерации
   - По умолчанию async, опция sync для критичных случаев
   - Улучшение UX (показ placeholder при генерации)

5. ✅ **Оптимизация изображений**
   - Интеграция с image optimizer
   - Автоматическое сжатие при загрузке
   - Конвертация в WebP (опционально)

6. ✅ **Извлечение длительности видео/аудио**
   - Интеграция с getid3 или ffprobe
   - Обработка ошибок gracefully
   - Тесты на различные форматы

---

### Фаза 3: Удобство использования (2-3 недели)

7. ✅ **Batch загрузка**
   - Endpoint для множественной загрузки
   - Валидация всех файлов
   - Массовое создание записей

8. ✅ **Очистка orphaned файлов**
   - Команда `media:cleanup-orphaned`
   - Dry-run режим
   - Логирование удалённых файлов

9. ✅ **Версионирование файлов**
    - Таблица `media_versions`
    - История изменений
    - Endpoint для просмотра версий

---

### Фаза 4: Продвинутые функции (3-4 недели)

10. ✅ **CDN invalidation**
    - Интеграция с CloudFront/Cloudflare
    - Автоматическая инвалидация
    - Логирование операций

11. ✅ **Watermarking**
    - Конфигурация водяных знаков
    - Применение к вариантам
    - Позиционирование и прозрачность

12. ✅ **Метрики и статистика**
    - Endpoint статистики
    - Агрегация данных
    - Интеграция с дашбордом

13. ✅ **Chunked upload**
    - Resumable upload (Tus или custom)
    - Прогресс загрузки
    - Восстановление после сбоя

---

## Технические детали реализации

### Дедупликация

```php
// app/Domain/Media/Actions/MediaStoreAction.php

private function findOrCreateMedia(UploadedFile $file, array $payload, string $checksum): Media
{
    $existing = Media::where('checksum_sha256', $checksum)->first();
    
    if ($existing) {
        // Обновить метаданные, если нужно
        if (!empty($payload['title']) || !empty($payload['alt'])) {
            $existing->fill($payload)->save();
        }
        return $existing;
    }
    
    // Создать новую запись
    return $this->createNewMedia($file, $payload, $checksum);
}
```

### Удаление файлов

```php
// app/Models/Media.php

protected static function booted(): void
{
    static::deleting(function (Media $media) {
        $disk = Storage::disk($media->disk);
        
        // Удалить варианты
        foreach ($media->variants as $variant) {
            if ($disk->exists($variant->path)) {
                $disk->delete($variant->path);
            }
        }
        
        // Удалить оригинал (только при force delete)
        if ($media->isForceDeleting() && $disk->exists($media->path)) {
            $disk->delete($media->path);
        }
    });
}
```

---

## Метрики успеха

После реализации улучшений:

- ✅ **Дедупликация**: снижение дубликатов на 80%+
- ✅ **Очистка файлов**: 0 orphaned файлов
- ✅ **Производительность**: время генерации вариантов < 500ms (async)
- ✅ **Метаданные**: 100% покрытие для видео/аудио
- ✅ **UX**: batch загрузка ускоряет процесс в 5+ раз

---

**Следующие шаги**:  
1. Создать задачи в трекере (GitHub Issues)
2. Начать с Фазы 1 (критичные исправления)
3. Обновить документацию после каждого улучшения

