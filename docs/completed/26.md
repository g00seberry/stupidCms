# Задача 26. Модель опций сайта (home page)

## Резюме
Сконструировать модель/репозиторий опций и удобные хелперы для чтения/записи значения **`site:home_entry_id`**. Изменение этой опции должно **немедленно** влиять на обработку корневого маршрута `/`: если задан валидный ID опубликованной записи — рендерить её как главную страницу; иначе — рендерить дефолтный шаблон.

Связанные задачи: 15 (миграции `options`), 30 (fallback маршрутизация), 32 (HomeController), 45 (ResponseCache), 50 (Admin API Options).

---

## Схема данных (напоминание)
Таблица `options`:
- `id`
- `namespace` (varchar)
- `key` (varchar)
- `value_json` (JSON) — хранит **примитив**/объект/массив
- `created_at`/`updated_at`

Уникальный индекс: `UNIQUE(namespace, key)`.

Рекомендуемый формат хранения примитивов: **прямое** JSON-значение (число/строка/булево), не заворачивать в объект.

---

## Контракты и компоненты

### Модель Eloquent
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Option extends Model
{
    protected $table = 'options';
    protected $fillable = ['namespace', 'key', 'value_json'];
    protected $casts = [
        'value_json' => 'json', // хранит любой JSON
    ];
}
```

### Репозиторий `OptionsRepository`
```php
namespace App\Domain\Options;

use App\Models\Option;
use Illuminate\Support\Facades\Cache;
use Illuminate\Contracts\Cache\Repository as CacheRepo;

final class OptionsRepository
{
    public function __construct(private CacheRepo $cache) {}

    private function cacheKey(string $ns, string $key): string
    { return "opt:{$ns}:{$key}"; }

    /** @return mixed|null */
    public function get(string $ns, string $key, mixed $default = null): mixed
    {
        $ck = $this->cacheKey($ns, $key);
        return $this->cache->tags(['options', "options:{$ns}"])
            ->rememberForever($ck, function() use ($ns, $key, $default) {
                $o = Option::query()->where(compact('ns','key'))->first();
                return $o?->value_json ?? $default;
            });
    }

    /** Сохраняет JSON-значение (примитив/массив/объект). */
    public function set(string $ns, string $key, mixed $value): void
    {
        Option::query()->updateOrCreate(
            ['namespace' => $ns, 'key' => $key],
            ['value_json' => $value],
        );
        // Инвалидация кэша опций и ответов
        $this->cache->tags(['options', "options:{$ns}"])->flush();
        event(new \App\Events\OptionChanged($ns, $key, $value));
    }

    public function getInt(string $ns, string $key, ?int $default = null): ?int
    { $v = $this->get($ns, $key, $default); return is_null($v) ? null : (int) $v; }
}
```

### Хелперы
```php
if (! function_exists('options')) {
    /** Удобное чтение опций: options('site','home_entry_id', null) */
    function options(string $ns, string $key, mixed $default = null): mixed {
        return app(\App\Domain\Options\OptionsRepository::class)->get($ns, $key, $default);
    }
}

if (! function_exists('option_set')) {
    function option_set(string $ns, string $key, mixed $value): void {
        app(\App\Domain\Options\OptionsRepository::class)->set($ns, $key, $value);
    }
}
```

> Регистрация: биндинг `OptionsRepository` в контейнер (через `AppServiceProvider`) и загрузка файла хелперов в `composer.json > autoload.files`.

### Событие для инвалидаций
```php
namespace App\Events;

class OptionChanged
{
    public function __construct(
        public readonly string $namespace,
        public readonly string $key,
        public readonly mixed $value,
    ) {}
}
```
В листенере можно очищать ResponseCache по тегу `options` и логировать аудит.

---

## Доменные правила для `site:home_entry_id`
- Значение: `null` или положительный `int`.
- При установке (через Admin API/CLI) допустимы **только** ID существующей записи `entries.id`.
- Публичный просмотр `/`:
  - Если опция не задана → рендер дефолтного шаблона `home.default` (200).
  - Если задана, но запись не найдена/недоступна (draft или `published_at > now()`) → рендер дефолта (200).
  - Если запись найдена и опубликована → рендер соответствующего Entry (шаблон выбора см. задачу 33).

> Intentionally **без 404** на `/` — главная всегда отвечает 200 (или 503 при авариях).

---

## Встраивание в веб-маршруты
Маршрут `/` указывает на `HomeController@show`.

```php
namespace App\Http\Controllers;

use App\Models\Entry;
use Carbon\Carbon;

final class HomeController
{
    public function __invoke()
    {
        $id = options('site','home_entry_id');
        if ($id) {
            $entry = Entry::query()
                ->whereKey($id)
                ->where('status','published')
                ->where('published_at','<=', Carbon::now('UTC'))
                ->first();
            if ($entry) {
                // Рендер через общий Page renderer
                return view('pages.show', ['entry' => $entry]);
            }
        }
        return view('home.default');
    }
}
```

---

## Admin API (касательно этой задачи)
Минимум — серверная логика. Эндпоинты и формы — в задачах 50/58. Для валидации используем `OptionsRequest`:
```php
public function rules(): array
{
    return [
        'value' => ['nullable','integer','min:1', function($attr,$val,$fail){
            if (! is_null($val) && ! \App\Models\Entry::query()->whereKey($val)->exists()) {
                $fail(__('Запись с таким ID не найдена'));
            }
        }],
    ];
}
```
Контроллер вызывает `option_set('site','home_entry_id', $validated['value'] ?? null)`.

---

## Кэширование и инвалидация
- Кэш опций — через `Cache::tags(['options','options:site'])`.
- При изменении — `OptionsRepository::set()` вызывает `tags()->flush()` + событие `OptionChanged`.
- Листенер события очищает ResponseCache с тегом `option:site` (если используется тегирование ответов).

---

## CLI-инструменты
Команда:
```bash
php artisan cms:options:set site home_entry_id 123
php artisan cms:options:get site home_entry_id
```
- В `set` — встроенная валидация существования `Entry`.
- В `get` — вывод в STDOUT JSON-значения.

---

## Аудит
При успешной установке `home_entry_id` писать запись в `audits`:
- `action = options.updated`
- `subject_type = 'option'`, `subject_id = 'site:home_entry_id'`
- `diff_json = {"old": <prev>, "new": <next>}`

---

## Тесты (PHPUnit)
1. **Чтение по умолчанию**: отсутствующая опция → `options('site','home_entry_id') === null`.
2. **Запись и чтение**: `option_set('site','home_entry_id', 42)` → `getInt(...) === 42`.
3. **Инвалидация кэша**: после `set()` повторный `get()` отдаёт новое значение без перезапуска.
4. **Валидация Admin API**: установка несуществующего ID → 422.
5. **Маршрут `/` дефолт**: без опции → рендер `home.default` (200).
6. **Маршрут `/` с опубликованной записью**: создать `Entry(published, now())`, поставить ID → `/` рендерит её.
7. **Маршрут `/` с черновиком**: `draft` → `/` рендерит дефолт.
8. **Удалённая запись**: soft-delete выбранного Entry → `/` рендерит дефолт.

---

## Приёмка (Definition of Done)
- [ ] Репозиторий и хелперы реализованы, зарегистрированы в контейнере.
- [ ] Событие `OptionChanged` отправляется, ResponseCache инвалидируется.
- [ ] Валидация установки опции не допускает несуществующих ID.
- [ ] Роут `/` корректно переключается между выбранной страницей и дефолтом.
- [ ] Все тесты из раздела выше зелёные.

---

## Нефункциональные аспекты
- **Безопасность**: только админ может изменять опции (middleware `admin.auth`).
- **Производительность**: все чтения опций — из кэша; запись редкая и дороже (инвалидация тегов).
- **Надёжность**: дефолтный рендер на `/` при любых проблемах с опцией/записью.
- **Локализация**: тексты ошибок валидатора — через `lang`.

---

## Расширение (out of scope)
- Страница «Настройки сайта» в админке с подбором страницы-главной (задача 58).
- Поддержка разных главных страниц по типам постов/условиям.
- Кэш-ключи на уровне CDN (Surrogate-Key \= `option:site`).

