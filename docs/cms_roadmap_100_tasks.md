# План разработки stupidCms — 100 последовательных задач

Ниже — 100 задач для реализации системы (Laravel backend + React/TS/MobX админка, плагины, поиск Elastic, медиа-пайплайн). У каждой задачи есть **детали выполнения** и **критерии приёмки**. Выполнять строго по порядку.

---

1. **Инициализировать монорепозиторий (Laravel + admin SPA)** - ok
   **Детали:** создать корневой каталог `cms/` с подпапками `backend/` и `admin/`; инициализировать git, добавить базовый README и `.gitignore`.  
   **Критерии приёмки:** репо создано; `git status` чистый; README с описанием структуры.

2. **Установить Laravel (PHP 8.2+)** - ok
   **Детали:** установить в `cms/backend`; настроить `composer.json`; проверить `artisan serve`.  
   **Критерии приёмки:** `php artisan --version` ок; домашняя страница Laravel открывается.

3. **Базовый `.env` (local)** - ok
   **Детали:** заполнить `APP_KEY`, `APP_URL`, DSN БД; `FILESYSTEM_DISK=public`.  
   **Критерии приёмки:** `php artisan config:cache` без ошибок; `php artisan migrate` коннектится к БД.

4. **Composer пакеты ядра** - ok
   **Детали:** добавить `lcobucci/jwt`, `intervention/image`, клиент ES, `spatie/laravel-responsecache`; обновить автолоад.  
   **Критерии приёмки:** `composer install` успешен; пакеты видны в `composer show`.

5. **Docker-compose (dev)** - ok
   **Детали:** описать сервисы nginx/php-fpm/mysql/redis/node; пробросить порты; общий network/volume.  
   **Критерии приёмки:** `docker compose up` поднимает стек; backend доступен по `http://localhost`.

6. **Redis для кэша/очередей** - ok
   **Детали:** подключить `predis`/ext-redis; прописать в `.env` драйверы; протестировать соединение.  
   **Критерии приёмки:** `php artisan queue:work` подключается к Redis; `CACHE_DRIVER=redis` работает.

7. **Базовый Makefile/скрипты** - ok
   **Детали:** команды `make up/down`, `make seed`, `npm dev/build`; alias для artisan.  
   **Критерии приёмки:** команды исполняются без ручного ввода длинных строк.

8. **Единый style-guide (PHP-CS-Fixer + EditorConfig)** - ok
   **Детали:** конфиги `.php-cs-fixer.php` и `.editorconfig`; добавить `composer fix`.  
   **Критерии приёмки:** `composer fix` не оставляет диффов на чистом коде.

9. **Инициализировать фронтенд админки (React+TS+Vite)** - ok
   **Детали:** создать проект в `cms/admin`; установить MobX, Router; настроить абсолютный импорт `@/`.  
   **Критерии приёмки:** `npm run dev` поднимает SPA на 5173; базовый маршрут работает.

10. **ESLint/Prettier для SPA** - ok
    **Детали:** настроить правила TS/React; добавить скрипт `npm run lint` и `format`.  
    **Критерии приёмки:** линтер проходит без ошибок; форматер выравнивает код.

11. **Миграция `post_types`** - ok
    **Детали:** таблица с `slug unique`, `name`, `template`, `options_json`; timestamps.  
     **Файлы миграций (MySQL):** [2025_11_06_000010_create_post_types_table.php](database/migrations/2025_11_06_000010_create_post_types_table.php)  
     **Критерии приёмки:** `php artisan migrate` добавляет таблицу; unique проверяется.

12. **Миграция `entries` (soft deletes)** - ok
    **Детали:** поля и индексы как в плане; `softDeletes()`; unique `(post_type_id, slug)` (через генерируемую `is_active`).  
    **Файлы миграций (MySQL):** [2025_11_06_000020_create_entries_table.php](database/migrations/2025_11_06_000020_create_entries_table.php)  
    **Критерии приёмки:** схема совпадает; `deleted_at` присутствует; уникальность работает для активных строк.

13. **Миграции таксономий** - ok
    **Детали:** `taxonomies`, `terms` (soft delete + is_active), `term_tree` (closure), `entry_term` (pivot).  
    **Файлы миграций (MySQL):** [2025_11_06_000030_create_taxonomies_table.php](database/migrations/2025_11_06_000030_create_taxonomies_table.php), [2025_11_06_000031_create_terms_table.php](database/migrations/2025_11_06_000031_create_terms_table.php), [2025_11_06_000032_create_term_tree_table.php](database/migrations/2025_11_06_000032_create_term_tree_table.php), [2025_11_06_000033_create_entry_term_table.php](database/migrations/2025_11_06_000033_create_entry_term_table.php)  
    **Критерии приёмки:** связи работают; миграции проходят.

14. **Миграция `media` (soft deletes)** - ok
    **Детали:** `media` (soft delete, sha256, meta_json), `media_variants` (variant_key), `entry_media` (RESTRICT удаления).  
    **Файлы миграций (MySQL):** [2025_11_06_000040_create_media_table.php](database/migrations/2025_11_06_000040_create_media_table.php), [2025_11_06_000041_create_media_variants_table.php](database/migrations/2025_11_06_000041_create_media_variants_table.php), [2025_11_06_000042_create_entry_media_table.php](database/migrations/2025_11_06_000042_create_entry_media_table.php)  
    **Критерии приёмки:** таблицы созданы; soft delete активен; FK/индексы корректны.

15. **Миграции `options` и `plugins`** - ok
    **Детали:** `options(namespace,key,value_json)` unique; `plugins` + `plugin_migrations` + `plugin_reserved`.  
    **Файлы миграций (MySQL):** [2025_11_06_000050_create_options_table.php](database/migrations/2025_11_06_000050_create_options_table.php), [2025_11_06_000060_create_plugins_tables.php](database/migrations/2025_11_06_000060_create_plugins_tables.php)  
    **Критерии приёмки:** обе таблицы есть; уникальные индексы работают.

16. **Миграция `reserved_routes`** - ok
    **Детали:** `path` unique, `kind('prefix'|'path')`, `source('core'|'plugin')`.  
    **Файлы миграций (MySQL):** [2025_11_06_000070_create_reserved_routes_table.php](database/migrations/2025_11_06_000070_create_reserved_routes_table.php)  
    **Критерии приёмки:** дубликаты запрещены; базовые пути будут сидиться отдельно.

17. **Миграция `entry_slugs` (история слугов)** - ok
    **Детали:** PK `(entry_id, slug)`, `is_current` + индекс `(entry_id,is_current)`; каскад при удалении Entry.  
    **Файлы миграций (MySQL):** [2025_11_06_000021_create_entry_slugs_table.php](database/migrations/2025_11_06_000021_create_entry_slugs_table.php)  
    **Критерии приёмки:** таблица есть; индексы корректны.

18. **Сид `admin` пользователя** - ok
    **Детали:** наличие таблицы `users`, сид с email/паролем (bcrypt/argon2).  
    **Связанная миграция:** [2025_11_06_000001_create_users_table.php](database/migrations/2025_11_06_000001_create_users_table.php)  
    **Критерии приёмки:** сид выполнен; входные данные задокументированы; запись в БД присутствует.

19. **Сид базовых PostTypes/Таксономий** - ok
    **Детали:** создать `page`; таксономии `categories(hierarchical=1)`, `tags(0)`.  
    **Критерии приёмки:** записи появились; айдишники фиксируются в сидере.

20. **Модели Eloquent и связи** - ok
    **Детали:** модели для всех таблиц; `Entry->postType`, `Entry->terms`; softDeletes trait.  
    **Критерии приёмки:** тесты на связи зелёные; `Entry::with('terms')` работает.

21. **Сервис транслитерации RU→lat** - ok
    **Детали:** реализовать `slugify()` с нормализацией, замены ё/й/ь, удаление пунктуации, dedupe.  
    **Критерии приёмки:** юнит-тесты: «Страница → stranica», конфликт → `stranica-2`.

22. **Правило уникальности слуга среди Pages** - ok
    **Детали:** кастомный Rule для уникальности в пределах `post_type=page`.  
    **Критерии приёмки:** сохранение дубля даёт 422 с понятной ошибкой.

23. **Проверка конфликтов с `reserved_routes`** - ok
    **Детали:** валидатор, который смотрит в конфиг и таблицу; case-insensitive.  
    **Критерии приёмки:** `admin`, `api` отклоняются.

24. **Обновление истории слугов** - ok
    **Детали:** сервис/обсервер `Entry` помечает старый `is_current=false`, пишет новый slug.  
    **Критерии приёмки:** после изменения — в `entry_slugs` ровно один `is_current=true`.

25. **Инварианты публикации** - ok
    **Детали:** валидация и доменный сервис: `published` ⇒ `published_at<=now`; draft игнорирует дату.  
    **Критерии приёмки:** нарушение возвращает 422; корректные кейсы проходят.

26. **Модель опций сайта (home page)** - ok
    **Детали:** helper `options('site','home_entry_id')`; сеттер через репозиторий.  
    **Критерии приёмки:** запись опции меняет поведение `/`.

27. **Политики/Abilities каркас** - ok
    **Детали:** `Gate::before()` для админа; Policies на Entry/Term/Media.  
    **Критерии приёмки:** админ имеет полный доступ; неавторизованный — 403.

28. **Сервис резервирования путей** - ok
    **Детали:** API `reservePath($path,$source)` с проверками; освобождение при выключении плагина.  
    **Критерии приёмки:** попытка повторного резерва — ошибка.

29. **HTTP middleware порядков** - ok
    **Детали:** настроить `RouteServiceProvider` порядок: системные → плагины/таксономии → fallback.  
    **Критерии приёмки:** тест-рут `/admin` не перехватывается fallback.

30. **Fallback маршрутизация плоских URL** - ok
    **Детали:** `/{slug}` с regex; исключение зарезервированных; `/` как Home.  
    **Критерии приёмки:** `/about` отдаёт страницу; `/admin` не попадает сюда.

31. **Контроллер публичной страницы** - ok
    **Детали:** `PageController@show` грузит Entry по slug и статусу/дате; 404 для недоступных.  
    **Критерии приёмки:** published виден, draft скрыт.

32. **Главная страница** - ok
    **Детали:** `HomeController@show`: читает опцию и рендерит Entry или дефолт.  
    **Критерии приёмки:** смена опции мгновенно меняет контент `/`.

33. **Blade шаблоны по приоритету** - ok
    **Детали:** стратегию выбора шаблонов вынести в сервис; покрыть 3 сценария.  
    **Критерии приёмки:** override > postType.template > default.

34. **Базовый Blade-layout и partials** - ok
    **Детали:** `layouts/app.blade.php`; partials `header`,`footer`; секции.  
    **Критерии приёмки:** страницы наследуют layout; partials подключаются без данных.

35. **Санитайзер richtext** - ok
    **Детали:** интегрировать HTMLPurifier/санитайзер; белый список тегов/атрибутов.  
    **Критерии приёмки:** `<script>` удаляется; `<a href>` остаётся.
    **Файлы реализации:** [35-richtext-sanitizer.md](docs/implemented/35-richtext-sanitizer.md)

36. **Cookie-based JWT: модель токенов** - ok
    **Детали:** функции выпуска/проверки access/refresh; сроки; ключи.  
    **Критерии приёмки:** сериализация/верификация проходят тесты.

37. **Аутентификация: `/api/v1/auth/login`**  
    **Детали:** принимает email/пароль; ставит `cms_at/cms_rt` HttpOnly+Secure+Strict.  
    **Критерии приёмки:** успешный вход → 200 + cookies; неверный → 401.

38. **Обновление токена: `/api/v1/auth/refresh`**  
    **Детали:** one-time refresh; ротация и блэклист старого.  
    **Критерии приёмки:** старый refresh не работает повторно.

39. **Выход: `/api/v1/auth/logout`**  
    **Детали:** инвалидировать refresh, очистить cookies.  
    **Критерии приёмки:** дальнейшие запросы без авторизации → 401.

40. **CSRF-cookie + заголовок**  
    **Детали:** эндпоинт выдаёт `cms_csrf`; проверка `X-CSRF-Token` на защищённых путях.  
    **Критерии приёмки:** POST без токена → 419/403; с токеном → 200.

41. **Админ middleware `admin.auth`**  
    **Детали:** извлечение access из cookie; отказ при невалидном.  
    **Критерии приёмки:** `/api/v1/admin/*` закрыт без логина.

42. **Вариации CORS/headers**  
    **Детали:** настроить CORS (если другой origin); `Vary: Cookie` на фронте.  
    **Критерии приёмки:** preflight успешен; toolbar не кэшируется.

43. **REST каркас `/api/v1`**  
    **Детали:** префикс версионирования; формат ошибок RFC7807; базовый контроллер.  
    **Критерии приёмки:** 404/422 возвращают JSON с типом/деталями.

44. **ETag/Last-Modified middleware**  
    **Детали:** генерировать `ETag` по хэшу ответа; поддержать 304.  
    **Критерии приёмки:** повторный GET → 304 без тела.

45. **Response Cache с тэгами**  
    **Детали:** интеграция spatie/responsecache; теги по entry/postType/term; skip при auth cookie.  
    **Критерии приёмки:** кэш сбрасывается при изменении данных; авторизованный не кэшируется.

46. **Admin API: PostTypes (read/update)**  
    **Детали:** эндпоинты чтения/обновления `options_json`; без delete/create для `page`.  
    **Критерии приёмки:** `GET/PUT /api/v1/admin/post-types/page` работают.

47. **Admin API: Entries**  
    **Детали:** список с фильтрами; CRUD; soft-delete; валидация slug/публикации.  
    **Критерии приёмки:** все операции покрыты интеграционными тестами.

48. **Admin API: Taxonomies/Terms**  
    **Детали:** CRUD таксономий, терминов; привязка к Entry.  
    **Критерии приёмки:** `POST terms` связывает с Entry; выдаёт актуальные pivot.

49. **Admin API: Media**  
    **Детали:** загрузка multipart; метаданные; soft-delete; ссылки для выбора.  
    **Критерии приёмки:** файл хранится; мета заполнена; удаление мягкое.

50. **Admin API: Options**  
    **Детали:** CRUD по `namespace/key`; валидация JSON.  
    **Критерии приёмки:** запись и чтение `site/home_entry_id` кругом.

51. **Admin API: Plugins**  
    **Детали:** список, enable/disable; `sync` запускает команду.  
    **Критерии приёмки:** статус меняется; роуты плагина подключаются/отключаются.

52. **Admin API: Search**  
    **Детали:** публичный `GET /api/v1/search`; админ-ребилд `POST /api/v1/admin/search/reindex`.  
    **Критерии приёмки:** пустой индекс отдаёт 200; ребилд запускается.

53. **Admin SPA: экран входа**  
    **Детали:** форма, отправка на `/auth/login`, хранение состояния (MobX), обработка ошибок.  
    **Критерии приёмки:** успешный вход редиректит в список; ошибка показывает сообщение.

54. **Admin SPA: список Pages**  
    **Детали:** таблица с фильтрами (статус/дата/таксономии); массовые операции.  
    **Критерии приёмки:** публикация/анпаблиш/треш работают и отражаются в UI.

55. **Admin SPA: редактор Page**  
    **Детали:** форма по схеме (title, slug auto, richtext, gallery); валидация ошибок.  
    **Критерии приёмки:** создание/редактирование сохраняет и показывает тосты.

56. **Admin SPA: таксономии**  
    **Детали:** экраны категорий (дерево, drag-n-drop) и тегов; привязка к Entry.  
    **Критерии приёмки:** смена родителя сохраняется; теги добавляются.

57. **Admin SPA: медиа-менеджер**  
    **Детали:** грид/лист, превью, аплоад, удаление; выбор в полях формы.  
    **Критерии приёмки:** из редактора можно выбрать и прикрепить файл.

58. **Admin SPA: опции**  
    **Детали:** UI выбора главной страницы; запись в Options API.  
    **Критерии приёмки:** выбор меняет `/` после сохранения.

59. **Admin SPA: плагины**  
    **Детали:** список; переключатель; кнопка `Sync`; отображение статуса.  
    **Критерии приёмки:** вкл/выкл меняет доступность маршрутов плагина.

60. **Admin SPA: Elastic панель**  
    **Детали:** показать статус алиасов/число доков; кнопка Reindex.  
    **Критерии приёмки:** запуск ребилда показывает прогресс/завершение.

61. **Система компонентов (ядро)**  
    **Детали:** реестр компонентов: `{slug, view, optional schema}`; blade-директива для рендера.  
    **Критерии приёмки:** регистрация компонента `hero` и его рендер работает.

62. **Partials как компоненты без схемы**  
    **Детали:** поддержка «пустых» схем; `header`/`footer` без пропсов.  
    **Критерии приёмки:** подключение без ошибок; нет требований к данным.

63. **Blocks поле (ядро)**  
    **Детали:** тип `blocks` — массив `{type, version, props}`; валидация по schema, если есть.  
    **Критерии приёмки:** запись с блоками сохраняется и читается.

64. **Рендер блоков на фронте**  
    **Детали:** маппинг `type → view`; проход по блокам; graceful-fallback.  
    **Критерии приёмки:** страница выводит блоки в порядке; неизвестный тип пропускается.

65. **Версионирование компонентов**  
    **Детали:** хранить `version`; механизм миграции props при изменениях.  
    **Критерии приёмки:** миграция переводит старые props к новой схеме.

66. **Санитайзер props**  
    **Детали:** очистка строк/HTML в props по белому списку.  
    **Критерии приёмки:** XSS вырезается; валидный HTML сохраняется.

67. **Конфиг Elasticsearch**  
    **Детали:** параметризация `.env`; клиент и health-check обёртка.  
    **Критерии приёмки:** код получает `cluster health` == green/yellow без ошибки.

68. **Схема индекса и алиасы**  
    **Детали:** создать `entries_v1`; выставить алиасы `entries_read/write`.  
    **Критерии приёмки:** `GET /_alias` показывает нужные алиасы.

69. **Анализаторы RU**  
    **Детали:** mapping для `title`/`content` с analyzer `russian`; lowercase/folding.  
    **Критерии приёмки:** mapping применён; документы принимаются.

70. **Индексатор очереди**  
    **Детали:** Jobs на create/update/delete Entry; сериализация `data_json` в content.  
    **Критерии приёмки:** при сохранении Entry появляется/обновляется документ в ES.

71. **Ребилд индекса**  
    **Детали:** команда создаёт новый индекс, переливает данные, атомарно свапает алиасы.  
    **Критерии приёмки:** поиск не падает во время ребилда; старый индекс удалён.

72. **Публичный поиск `/api/v1/search`**  
    **Детали:** параметры `q, postType, terms, sort`; хайлайт.  
    **Критерии приёмки:** фильтры работают; подсветка приходит в ответе.

73. **Исключение черновиков**  
    **Детали:** в публичный индекс пишем только `published && date<=now`.  
    **Критерии приёмки:** draft не появляется в поиске гостя.

74. **Админский поиск**  
    **Детали:** флаг/индекс для черновиков; эндпоинт с auth.  
    **Критерии приёмки:** админ видит и draft, и published.

75. **SPA: форма поиска**  
    **Детали:** UI с строкой запроса и фильтрами; пагинация.  
    **Критерии приёмки:** результаты соответствуют API; пагинация кликабельна.

76. **Медиа: загрузка и метаданные**  
    **Детали:** обработка EXIF ориентации; заполнение полей; проверка MIME.  
    **Критерии приёмки:** перевёрнутые фото нормализуются; неверный MIME отклоняется.

77. **Хеш контента и дубликаты**  
    **Детали:** считать SHA-256; при совпадении — опция линковать вместо дублирования.  
    **Критерии приёмки:** повторная загрузка детектируется; сценарий линковки работает.

78. **Генерация деривативов (image)**  
    **Детали:** пресеты thumb/medium/large/webp/avif; очередь или on-demand.  
    **Критерии приёмки:** файлы генерируются; пути фиксируются в `meta_json.variants`.

79. **Водяной знак (опционально)**  
    **Детали:** конфиг с включением/изображением/позициями; часть ключа варианта.  
    **Критерии приёмки:** при включении watermark виден на деривативах.

80. **Focal point**  
    **Детали:** UI выбора точки; хранение в `meta_json`; кроп учитывает точку.  
    **Критерии приёмки:** кроп центрируется по фокусу.

81. **Видео/аудио/доки**  
    **Детали:** записывать MIME/длину (где возможно); постер кадра для видео (FFmpeg).  
    **Критерии приёмки:** видео имеет превью; аудио/доки корректно отображаются в списке.

82. **Удаление (soft) и очистка орфанов**  
    **Детали:** защита удаления, если media привязан; отчёт об неиспользуемых.  
    **Критерии приёмки:** попытка удалить используемый файл отклоняется; отчёт строится.

83. **Поле `images`/`image`/`file`**  
    **Детали:** типовые поля, работающие с медиа-пикером; множественный выбор.  
    **Критерии приёмки:** выбор/снятие выбора корректно сохраняется.

84. **Он-деманд деривативы через подписанный URL**  
    **Детали:** маршрут генерации с подписью/ttl; кэширование результата.  
    **Критерии приёмки:** первая выдача генерит файл; повторная — из кэша.

85. **Плагин-фреймворк: структура `/plugins`**  
    **Детали:** `plugin.json`, `PluginServiceProvider`, `routes`, `migrations`, `views`; автодискавери.  
    **Критерии приёмки:** тестовый плагин регистрируется и рендерит view.

86. **Команда `cms:plugins:sync`**  
    **Детали:** скан каталогов, регистрация, миграции, очистка кэшей, резерв путей.  
    **Критерии приёмки:** запуск синхронизирует плагины и их состояния.

87. **Манифест зависимостей**  
    **Детали:** поля `requires/conflicts`; топологическая сортировка; валидация версий.  
    **Критерии приёмки:** конфликт блокирует загрузку с понятным сообщением.

88. **Хуки/события (actions/filters)**  
    **Детали:** реестр событий и контрактов; API подписки; приоритеты.  
    **Критерии приёмки:** плагин модифицирует payload через filter; action вызывается.

89. **Реестр компонентов из плагинов**  
    **Детали:** публичный API `ComponentRegistry::register` для провайдеров; namespace views.  
    **Критерии приёмки:** компонент из плагина доступен в блоках/рендерится.

90. **Безопасная изоляция плагинов**  
    **Детали:** ограничение namespace; валидация провайдера по классу; запрещён произвольный eval.  
    **Критерии приёмки:** плагин без валидного провайдера не грузится.

91. **Плагин Redirects: миграция и модель**  
    **Детали:** таблица `redirects(from_path,to_path,code,hit_count)`; индексы на `from_path`.  
    **Файлы миграций (MySQL):** [2025_11_06_000100_create_redirects_table.php](database/migrations/2025_11_06_000100_create_redirects_table.php)  
    **Критерии приёмки:** CRUD через Tinker/API работает.

92. **Middleware Redirects**  
    **Детали:** подключить до fallback страниц; увеличивать `hit_count`.  
    **Критерии приёмки:** запросы на `from` отдают 301/302 и считают хиты.

93. **Интеграция с историей слугов**  
    **Детали:** при смене slug создавать 301 со старого на новый.  
    **Критерии приёмки:** старый URL переадресует на текущий.

94. **Плагин Blocks: UI редактор**  
    **Детали:** интерфейс добавления/перетаскивания/удаления блоков; редактирование props по schema.  
    **Критерии приёмки:** операции сохраняются; валидация props работает.

95. **Плагин Blocks: базовые блоки**  
    **Детали:** `hero`, `gallery`, `faq` с Blade-шаблонами и схемами; превью в админке.  
    **Критерии приёмки:** блоки корректно отображаются на фронте.

96. **Плагин Blocks: миграции версий схем**  
    **Детали:** механизм миграции props при увеличении `version`; кнопка «обновить».  
    **Критерии приёмки:** старые блоки мигрируют без потерь данных.

97. **Плагин Seo: UI и мета-логика**  
    **Детали:** форма `title/description/robots/canonical`; маски по умолчанию.  
    **Критерии приёмки:** сохранённые мета попадают в `<head>`.

98. **Плагин Seo: sitemap/robots/og-image**  
    **Детали:** генерация `sitemap.xml`, `robots.txt`; og-image по шаблону канваса.  
    **Критерии приёмки:** файлы доступны по URL; og-image генерится.

99. **Микро-панель администратора (toolbar)**  
    **Детали:** отображать при наличии auth cookie; ссылки «Редактировать», «К списку»; отключать кэш.  
    **Критерии приёмки:** гость панель не видит; у админа видна на страницах.

100. **Смоук-тесты и релиз v0.1.0**  
     **Детали:** E2E сценарий: логин → создать Page → медиа → блоки → publish → фронт → поиск → смена slug → 301; оформить CHANGELOG и тег.  
     **Критерии приёмки:** сценарий проходит; тег `v0.1.0` создан; README обновлён инструкциями запуска.
