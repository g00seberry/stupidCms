# План упрощения системы валидации

## Цель

Полностью переработать систему валидации с принципом: **вся настройка на совести пользователя, никаких проверок для правил, любой path может принять любой rule**.

## Текущие проблемы (что убираем)

1. **Проверки совместимости правил с типами данных** — убрать
2. **Специальная обработка для cardinality** — убрать
3. **Автоматическое добавление базовых типов данных** — убрать
4. **Ограничения на применение правил** (например, `array_unique` только для `many`) — убрать
5. **Сложная логика преобразования путей** — упростить
6. **Доменный слой Rule объектов** — упростить

## Новая архитектура

### Принципы

1. **Прямое преобразование** — `validation_rules` из Path напрямую преобразуются в Laravel правила
2. **Нет проверок** — система не проверяет совместимость правил с типами данных или cardinality
3. **Пользователь отвечает** — пользователь сам настраивает правила, система их просто применяет

## План изменений

### Этап 1: Упрощение PathValidationRulesConverter

**Текущее состояние:**

-   Проверяет `cardinality` для `required`/`nullable`
-   Проверяет `cardinality` для `array_unique`
-   Передаёт `dataType` в Rule объекты

**Новое состояние:**

-   Просто преобразует все ключи из `validation_rules` в Rule объекты
-   Не проверяет `cardinality`
-   Не передаёт `dataType` (или передаёт, но не использует для проверок)

**Изменения:**

-   Убрать методы `handleRequiredRule()`, `handleArrayUniqueRule()`
-   Упростить `convert()` — убрать проверки
-   неизвестные правила? - кидать исключение

### Этап 2: Упрощение Rule объектов

**Текущее состояние:**

-   Каждое правило — отдельный класс (MinRule, MaxRule, etc.)
-   Правила хранят `dataType` для специальной обработки

**Новое состояние:**

-   Упростить Rule объекты — убрать зависимость от `dataType`
-   Handlers получают только значение правила, без `dataType`

**Вариант A (минимальные изменения):**

-   Оставить существующие Rule классы
-   Убрать `dataType` из конструкторов
-   Упростить handlers — не использовать `dataType` для проверок

### Этап 3: Упрощение LaravelValidationAdapter

**Текущее состояние:**

-   Автоматически добавляет базовые типы данных на основе `dataType`
-   Специальная обработка для `json` типа (JsonObject)
-   Специальная обработка для массивов
-   Управление порядком правил (required → array → остальные)

**Новое состояние:**

-   Не добавляет базовые типы автоматически
-   Не добавляет JsonObject автоматически
-   Не управляет порядком правил (пользователь сам указывает порядок)
-   Просто преобразует Rule объекты в строки через handlers

**Изменения:**

-   Убрать `addBaseTypeForField()`
-   Убрать `processArrayElementFields()`
-   Убрать `addBaseTypesForFieldsWithoutRules()`
-   Убрать `ensureArrayRulePosition()`
-   Упростить `adapt()` — только преобразование через handlers

### Этап 4: Упрощение Handlers

**Текущее состояние:**

-   Handlers получают `dataType` и используют его для преобразования
-   MinRuleHandler/MaxRuleHandler проверяют тип данных

**Новое состояние:**

-   Handlers не получают `dataType`
-   Просто преобразуют Rule в строку Laravel
-   Не делают проверок совместимости

**Изменения:**

-   Убрать параметр `dataType` из `handle()` или сделать его опциональным
-   Упростить логику в handlers — убрать проверки типов

### Этап 5: Упрощение BlueprintValidationTrait

**Текущее состояние:**

-   Строит маппинг `dataTypes`
-   Добавляет правило `'array'` для полей с `cardinality: 'many'`
-   Управляет порядком добавления правил
-   Специальная обработка для элементов массивов

**Новое состояние:**

-   Не строит маппинг `dataTypes` (или строит, но не использует)
-   Не добавляет правила автоматически
-   Не управляет порядком
-   Просто добавляет все правила из адаптера

**Изменения:**

-   Упростить `addBlueprintValidationRules()` — убрать всю логику
-   Убрать `buildDataTypesMapping()` или сделать опциональным
-   Убрать `addArrayRulesForManyFields()`
-   Убрать `ensureArrayRuleForJsonArrayElements()`
-   Упростить `addRulesInCorrectOrder()` — просто добавлять все правила

### Этап 6: Упрощение FieldPathBuilder

**Текущее состояние:**

-   Заменяет сегменты на `.*` для полей внутри массивов
-   Учитывает `cardinality` родительских путей

**Новое состояние:**

-   Оставить как есть (преобразование путей всё равно нужно)

**Рекомендация:** Оставить как есть, но убрать зависимость от `cardinality` если она не нужна

### Этап 7: Упрощение EntryValidationService

**Текущее состояние:**

-   Создаёт маппинг `pathCardinalities` для FieldPathBuilder
-   Передаёт `cardinality` в PathValidationRulesConverter

**Новое состояние:**

-   Не создаёт маппинг `cardinality` (если не нужен для путей)
-   Не передаёт `cardinality` в конвертер

**Изменения:**

-   Упростить `buildRulesFor()` — убрать передачу `cardinality`

### Этап 8: Удаление ненужных компонентов

**Компоненты для удаления/упрощения:**

-   `DataTypeMapper` — не нужен, если не добавляем типы автоматически
-   `RuleArrayManipulator` — не нужен, если не управляем порядком
-   Специальная обработка `JsonObject` — убрать
-   Кэширование в `BlueprintContentValidator` — оставить (производительность)

## Новая структура данных validation_rules

### Формат (без изменений)

```php
[
    'required' => true,
    'min' => 1,
    'max' => 100,
    'pattern' => '/^[a-z]+$/',
    'array_min_items' => 2,
    'array_max_items' => 10,
    'array_unique' => true,
    'required_if' => ['field' => 'other_field', 'value' => true],
    'field_comparison' => ['operator' => '>=', 'field' => 'start_date'],
    // Любые другие правила - будут преобразованы напрямую
    'custom_rule' => 'value',
]
```

### Преобразование

1. Каждый ключ → Rule объект (или GenericRule)
2. Rule объект → Handler → строка Laravel
3. Все строки объединяются в массив правил

### Шаг 1: Подготовка

### Шаг 2: Упрощение конвертера

-   Убрать проверки из PathValidationRulesConverter

### Шаг 3: Упрощение адаптера

-   Убрать автоматическое добавление типов
-   Упростить handlers

### Шаг 4: Упрощение trait

-   Убрать всю логику из BlueprintValidationTrait
-   Оставить только вызов адаптера

### Шаг 6: Очистка

-   Удалить неиспользуемые компоненты
-   Обновить документацию
