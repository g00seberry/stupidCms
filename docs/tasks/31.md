# Задача 31. Контроллер публичной страницы

## Резюме
Реализовать `PageController@show` для отдачи публичной страницы по slug. Контроллер:
- Ищет Entry по текущему slug.
- Разрешает только опубликованные записи: `status='published'` и `published_at <= now()` (см. Задачу 25).
- Возвращает **404** для черновиков, будущих публикаций и отсутствующих слугов.

**Критерии приёмки:**
- Published-страница видна.
- Draft-страница (или с будущей датой) скрыта (404).

Связанные: 21 (slugify), 24 (история слугов), 25 (инварианты публикации), 30 (маршрутизация), 33 (рендерер страницы), 93 (redirects для устаревших слугов).

---

## Контракт
Маршрут определён в Задаче 30: `GET /{slug}` → `PageController@show`.

**Вход:** `slug` (ASCII `[a-z0-9-]+`).

**Выход:**
- 200 — HTML-страница.
- 404 — если запись не найдена или не доступна публично.

---

## Поиск записи
Используем модель `Entry` с полями `slug`, `status`, `published_at`.

```php
namespace App\Http\Controllers;

use App\Models\Entry;
use Carbon\Carbon;
use Illuminate\Contracts\View\Factory as ViewFactory;
use Illuminate\Http\Request;

final class PageController
{
    public function __construct(private ViewFactory $view) {}

    public function show(Request $request, string $slug)
    {
        // Текущий слуг — без истории. Редиректы по старым слугам — в отдельном плагине (см. Задачу 93).
        $entry = Entry::query()
            ->where('slug', $slug)
            ->where('status', 'published')
            ->where('published_at', '<=', Carbon::now('UTC'))
            ->first();

        if (! $entry) {
            abort(404);
        }

        // Дальнейший рендер через общий шаблон/view-компонент
        return $this->view->make('pages.show', [
            'entry' => $entry,
            // meta, breadcrumbs и т.д. — вне текущей задачи
        ]);
    }
}
```

> Если требуется поддержка истории слугов (Задача 24), можно внедрить сервис `SlugResolver`:
> 1) найти по `entries.slug`,
> 2) иначе — по `entry_slugs.slug` где `is_current=1` → загрузить Entry.

---

## Шаблон `resources/views/pages/show.blade.php`
Минимальный пример:
```blade
@extends('layouts.public')

@section('title', $entry->title)

@section('content')
  <article class="prose">
    <h1>{{ $entry->title }}</h1>
    {!! $entry->body_html !!}
  </article>
@endsection
```

> В реальной системе используется компонентный рендерер (задача 33); тут — упрощённо.

---

## Индексы и производительность
- Индекс по `entries.slug` (UNIQUE) обязателен.
- Запрос один, без JOIN. При использовании истории — JOIN по `entry_slugs`.

---

## Кэширование
- Можно выставлять заголовки `Cache-Control`/`ETag` в middleware.
- Инвалидация при обновлении `Entry` (события `saved`, `deleted`).

---

## Тесты (Feature)
1. **Published OK**:
   - given: `Entry::factory()->create(['slug'=>'about','status'=>'published','published_at'=>now('UTC')->subMinute()])`
   - when: `GET /about`
   - then: 200 и содержит заголовок.
2. **Draft 404**:
   - given: `Entry::factory()->create(['slug'=>'draft','status'=>'draft'])`
   - when: `GET /draft`
   - then: 404.
3. **Future 404**:
   - given: `Entry::factory()->create(['slug'=>'future','status'=>'published','published_at'=>now('UTC')->addHour()])`
   - when: `GET /future`
   - then: 404.
4. **Unknown 404**: `GET /nope` → 404.

---

## Приёмка (Definition of Done)
- [ ] Контроллер `PageController@show` реализован.
- [ ] Published видны, draft/future скрыты (404).
- [ ] Индекс по `entries.slug` существует.
- [ ] Тесты зелёные.

---

## Расширение (out of scope)
- Поддержка локализаций (`/{locale}/{slug}`).
- Кеш/варианты (AMP, JSON-API).
- Интеграция со схемой редиректов по старым слугам (301).

