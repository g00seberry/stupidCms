# Задача 32. Главная страница

## Резюме
Реализовать `HomeController@__invoke` (или `show`), который читает опцию `site:home_entry_id` и рендерит:
- если опция указывает на опубликованную запись — эту запись как главную страницу;
- иначе — дефолтный шаблон главной (`home.default`).

**Критерии приёмки:** смена опции **мгновенно** меняет контент `/` (без рестартов и без ожидания кэшей).

Связанные: 25 (инварианты публикации), 26 (модель опций), 29 (порядок роутинга), 30 (fallback), 31 (PageController/рендер записи), 45 (ResponseCache/инвалидация), 33 (выбор шаблона).

---

## Маршрут
В `routes/web_core.php` (загружается **до** контентных и fallback):
```php
use App\Http\Controllers\HomeController;

Route::get('/', HomeController::class)->name('home');
```

---

## Контроллер
```php
namespace App\Http\Controllers;

use App\Models\Entry;
use Carbon\Carbon;
use Illuminate\Contracts\View\Factory as ViewFactory;

final class HomeController
{
    public function __construct(private ViewFactory $view) {}

    public function __invoke()
    {
        $id = options('site','home_entry_id'); // Задача 26
        if ($id) {
            $entry = Entry::query()
                ->whereKey($id)
                ->where('status','published')
                ->where('published_at','<=', Carbon::now('UTC'))
                ->first();
            if ($entry) {
                // Унифицированный рендер записи через сервис выбора шаблонов (Задача 33)
                $template = app(\App\Domain\View\TemplateResolver::class)->forEntry($entry);
                return $this->view->make($template, ['entry' => $entry]);
            }
        }
        return $this->view->make('home.default');
    }
}
```

> Контроллер **не кеширует** в себе результат — читает опцию на каждый HTTP-запрос (микро-стоимость приемлема, опция читается из кэша с тегами, см. Задача 26).

---

## Инвалидация и «мгновенность» изменений
- Репозиторий опций (Задача 26) при `set()` вызывает `cache->tags(['options','options:site'])->flush()` и диспатчит `OptionChanged`.
- Листенер `onOptionChanged` для ключа `site:home_entry_id`:
  - Инвалидирует ResponseCache/HTTP-кэш страницы `/` (если используется) — по тегу `route:/` или `option:site`.
  - (Опционально) сбрасывает внутренние preloader-и.

Таким образом, после `option_set('site','home_entry_id', X)` следующий запрос к `/` отдаст новый контент.

---

## Шаблоны
- `resources/views/home/default.blade.php` — базовый лендинг, может содержать виджеты.
- Рендер записи на главной использует **те же** правила выбора шаблона, что и обычная страница (Задача 33).

---

## Ошибочные ситуации
- ID указывает на удалённую/черновую/будущую запись — показываем дефолтный шаблон без 404.
- Некорректное значение опции (строка/ноль) — воспринимаем как отсутствие (проверка типа в валидаторе Admin API, Задача 26).

---

## Тесты (Feature)
1. **Default**: без опции — `GET /` → 200, view `home.default`.
2. **Published entry**: создать `Entry` с `published_at <= now`, сохранить `home_entry_id = id` → `GET /` → 200, выбран view из TemplateResolver, в контексте есть `entry`.
3. **Draft**: `home_entry_id = draft.id` → `GET /` → 200, view `home.default`.
4. **Future**: `home_entry_id = future.id` → `GET /` → 200, view `home.default`.
5. **Instant change**:
   - шаг А: `option_set('site','home_entry_id', entryA.id)` → `GET /` содержит `entryA.title`;
   - шаг Б: `option_set('site','home_entry_id', entryB.id)` → следующий `GET /` содержит `entryB.title`.
6. **Route order**: убедиться, что `/` не перехватывается контентным `/{slug}` (см. задачу 29) — `assertRouteIs('home')`.

---

## Приёмка (Definition of Done)
- [ ] Маршрут `/` объявлен в core и указывает на `HomeController`.
- [ ] Контроллер читает опцию и корректно выбирает между entry и дефолтом.
- [ ] Смена опции мгновенно отражается на ответе / (инвалидация работает).
- [ ] Тесты зелёные.

---

## Нефункциональные аспекты
- **Производительность**: чтение опции из кеша O(1); один запрос к БД при наличии ID.
- **Надёжность**: при любой ошибке загрузки записи контроллер возвращает дефолт, а не 500.
- **Безопасность**: публичный маршрут без авторизации; админка ограничена по политике (Задача 27).

