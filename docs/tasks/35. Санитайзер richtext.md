# Задача 35. Санитайзер richtext

## Резюме
Интегрировать серверный HTML‑санитайзер (HTMLPurifier) и предоставить сервис/фасад для очистки richtext‑поля перед сохранением/рендерингом. Базовый профиль: разрешить безопасные теги и атрибуты; скрипты/инлайновые обработчики удалить.

**Критерии приёмки:**
- `<script>` полностью удаляется.
- Ссылка `<a href="https://example.com">` сохраняется (атрибут `href` не удаляется).

Связанные: 31 (PageController), 33 (рендер шаблонов), 60 (Admin: WYSIWYG), 62 (Media embeds), 70 (XSS‑защита в комментариях/формах).

---

## Пакет и установка
Рекомендуемый пакет: `enshrined/laravel-htmlpurifier` (обёртка над HTMLPurifier).

```bash
composer require enshrined/laravel-htmlpurifier
php artisan vendor:publish --provider="Mews\\Purifier\\PurifierServiceProvider" --tag=config
```
Это создаст `config/purifier.php`.

---

## Конфигурация профиля `cms_default`
В `config/purifier.php` добавить профиль `cms_default`:
```php
return [
    'settings' => [
        'cms_default' => [
            'HTML.Doctype' => 'HTML5',
            'Cache.SerializerPath' => storage_path('app/purifier'),

            // Теги/атрибуты
            'HTML.AllowedElements' => [
                'a','abbr','b','blockquote','br','code','em','i','hr','img','li','ol','p','pre','s','small','strong','sub','sup','u','ul','h1','h2','h3','h4','h5','h6','figure','figcaption'
            ],
            'HTML.AllowedAttributes' => [
                'a.href','a.title','a.target','a.rel',
                'img.src','img.alt','img.title','img.width','img.height',
            ],
            'URI.AllowedSchemes' => [ 'http' => true, 'https' => true, 'mailto' => true ],

            // Удаляем скрипты/ивенты
            'HTML.SafeScripting' => [],
            'HTML.SafeEmbed' => false,
            'HTML.SafeObject' => false,
            'Attr.EnableID' => false,
            'Attr.ForbiddenPatterns' => ['/^on.*/i'], // onload, onclick и т.д.

            // Автоформатирование
            'AutoFormat.RemoveEmpty' => true,
            'AutoFormat.Linkify' => false, // ссылкование оставим на редактор
            'AutoFormat.AutoParagraph' => false,

            // Изображения
            'URI.DisableExternalResources' => false,
            'CSS.AllowedProperties' => [], // стили запрещаем в базе профиля
        ],
    ],
];
```

> При необходимости можно иметь «расширенный» профиль с разрешёнными iframes (YouTube/Vimeo) через `HTML.SafeIframe` и `URI.SafeIframeRegexp` — **вне этой задачи**.

---

## Сервис санитизации
`app/Domain/Sanitizer/RichTextSanitizer.php`
```php
namespace App\Domain\Sanitizer;

use Mews\Purifier\Facades\Purifier;

final class RichTextSanitizer
{
    public function __construct(private string $profile = 'cms_default') {}

    public function sanitize(string $html): string
    {
        $clean = Purifier::clean($html, $this->profile);
        // Пост‑обработка: если ссылка с target="_blank", гарантируем rel="noopener noreferrer"
        $clean = preg_replace_callback(
            '#<a\b[^>]*>#i',
            function(array $m){
                $tag = $m[0];
                if (!preg_match('#target\s*=\s*"?_blank"?#i', $tag)) return $tag;
                if (preg_match('#rel\s*=#i', $tag)) return $tag; // оставим как есть
                return rtrim(substr($tag, 0, -1)) . ' rel="noopener noreferrer">';
            },
            $clean
        );
        return $clean;
    }
}
```

### Регистрация в контейнере
```php
$this->app->singleton(\App\Domain\Sanitizer\RichTextSanitizer::class);
```

---

## Точки применения
1. **Перед сохранением `Entry`**: в Application Service (или Observer) очищать `body_html`/`excerpt_html`:
```php
$san = app(\App\Domain\Sanitizer\RichTextSanitizer::class);
$payload['body_html'] = $san->sanitize($payload['body_html'] ?? '');
```
2. **Импорт/сид**: прогонять через сервис.

> На этапе рендера в Blade используем `{!! $entry->body_html !!}` — доверяем уже очищенному HTML.

---

## Тесты (PHPUnit)
```php
public function test_script_removed_and_anchor_kept()
{
    $san = app(\App\Domain\Sanitizer\RichTextSanitizer::class);

    $html = '<p>Hello</p><script>alert(1)</script><a href="https://example.com">x</a>';
    $clean = $san->sanitize($html);

    $this->assertStringNotContainsString('<script', $clean);
    $this->assertStringContainsString('<a href="https://example.com"', $clean);
}

public function test_target_blank_gets_rel_noopener()
{
    $san = app(\App\Domain\Sanitizer\RichTextSanitizer::class);
    $html = '<a href="https://ex.com" target="_blank">ex</a>';
    $clean = $san->sanitize($html);
    $this->assertStringContainsString('rel="noopener noreferrer"', $clean);
}
```

---

## Приёмка (Definition of Done)
- [ ] Пакет установлен, опубликована конфигурация.
- [ ] Добавлен профиль `cms_default` с белым списком тегов/атрибутов.
- [ ] Реализован сервис `RichTextSanitizer` и внедрён в сохранение Entry.
- [ ] Юнит‑тест подтверждает: `<script>` удаляется, `<a href>` остаётся.

---

## Нефункциональные и безопасность
- **XSS:** запрещены `on*`‑атрибуты, `javascript:` схемы и `<script>`.
- **Схемы:** только `http/https/mailto` для ссылок.
- **Кэш:** включён сериализованный кэш HTMLPurifier (Storage), что ускоряет очистку.

---

## Расширение (out of scope)
- Профиль `cms_embed` для iframe (YouTube/Vimeo) с whitelisting по Regex.
- Мягкое «причесывание» разметки (таблицы, списки) и тонкая конфигурация CSS.
- Отложенная санитизация в очереди для больших документов.

