# Задача 25. Инварианты публикации

## Резюме
Реализовать жёсткие правила публикации записей (`entries`):
- Если `status = 'published'`, тогда `published_at` **обязательно** должно быть `<= now()` (UTC).
- Если `status = 'draft'`, значение `published_at` игнорируется (может быть `NULL` или любой датой, но не влияет на доступность записи).
- При попытке нарушить правила — возвращать `422 Unprocessable Entity` в формате **RFC 7807**.

## Зачем
Это исключает «рассинхрон» между статусом и датой, не допускает «будущих публикаций» в состоянии `published` (отложенные публикации на этом этапе не поддерживаются), упрощает поисковые выдачи и кэш.

## Модель данных
Таблица `entries` уже содержит поля:
- `status ENUM('draft','published')`
- `published_at DATETIME NULL` (в **UTC**)

Хранилище времени — UTC. Преобразования в часовой пояс выполняются на уровне UI.

## Правила и автоматизация
1. **Автозаполнение даты при публикации**: если `status` меняется на `published` и `published_at` не передан — система проставляет `now()` (UTC).
2. **Запрет будущих дат**: если `status='published'` и `published_at > now()` — ошибка `422` c полем `published_at`.
3. **Снятие публикации**: перевод `published → draft` разрешён без изменений `published_at`.
4. **Обновление опубликованной записи**: если дата не меняется — допускается; если меняется на будущее — `422`.

## Контракты
### FormRequest-валидация
- `StoreEntryRequest`, `UpdateEntryRequest`:
  - Базовая валидация типов (string/date/enum).
  - Кастомное правило `PublishedDateNotInFuture`:
    - При `status=published` проверяет `published_at == null ? pass : <= now()`.

### Доменный сервис `PublishingService`
```php
final class PublishingService
{
    public function applyAndValidate(array $payload, ?Entry $existing = null): array
    {
        // 1) Автозаполнение
        if (($payload['status'] ?? $existing?->status) === 'published') {
            if (empty($payload['published_at'])) {
                $payload['published_at'] = Carbon::now('UTC');
            }
        }
        // 2) Инвариант
        if (($payload['status'] ?? 'draft') === 'published' && Carbon::parse($payload['published_at'])->gt(Carbon::now('UTC'))) {
            throw ValidationException::withMessages([
                'published_at' => __('Дата публикации не может быть в будущем для статуса "published"'),
            ]);
        }
        return $payload;
    }
}
```
> Сервис вызывается из use-case слоя (контроллер или Application Service) **до** сохранения модели.

## Изменения в чтении (scopes)
Добавить скоупы в модель `Entry`:
```php
public function scopePublished($q)
{
  return $q->where('status','published')->where('published_at','<=',Carbon::now('UTC'));
}
```
- Публичные выборки используют `Entry::published()`.

## Формат ошибок (RFC 7807)
Пример HTTP 422:
```json
{
  "type": "https://stupidcms.dev/problems/validation-error",
  "title": "Validation Failed",
  "status": 422,
  "detail": "The given data was invalid.",
  "errors": {
    "published_at": ["Дата публикации не может быть в будущем для статуса 'published'."]
  }
}
```

## Изменения в админке (UX)
- Поле-переключатель статуса `draft/published`.
- Поле `published_at` (datetime-local):
  - При выборе `published` по умолчанию заполняется «сейчас» в часовом поясе пользователя (UI конвертирует в UTC для API).
  - Отобразить подсказку: «Публикация невозможна с будущей датой. Для отложенной публикации используйте статус `draft`.».
- При ошибке 422 подсветить поле и вывести текст из `errors.published_at[0]`.

## Тесты (PHPUnit + Feature)
1. **Draft без даты**: `status=draft`, `published_at=null` → 200/201 OK.
2. **Publish без даты**: `status=published`, `published_at` отсутствует → проставляется `now()`; запись доступна в `scopePublished`.
3. **Publish c прошедшей датой**: → OK.
4. **Publish c будущей датой**: → 422; тело соответствует RFC 7807; ключ `published_at` присутствует.
5. **Update published без изменения даты**: → OK.
6. **Update published с переводом даты в будущее**: → 422.
7. **Unpublish**: `published → draft` с любой датой → OK, в публичном списке запись пропадает.
8. **Scope boundary**: запись с `published_at = now()` попадает в `scopePublished`.

## Приёмка (готовность к «OK»)
- [ ] Валидация реализована в FormRequest + сервисе.
- [ ] Контроллеры используют `PublishingService::applyAndValidate()`.
- [ ] Скоуп `published()` добавлен и используется в публичном контроллере.
- [ ] Все тесты зелёные; ошибки формируются по RFC 7807.

## Нефункциональные аспекты
- **Время/таймзона**: хранение в UTC, отображение в TZ пользователя; серверный `now()` — `Carbon::now('UTC')`.
- **Кэширование**: ResponseCache должен инвалидироваться при смене `status`/`published_at`.
- **ES-индекс**: индексатор публикует документы только из `scopePublished()`.

## Расширение в будущем (out of scope)
- Статус `scheduled` и планировщик публикаций.
- Временная зона по сайту (site-wide TZ).

