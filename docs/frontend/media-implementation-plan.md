# План реализации функционала работы с медиафайлами на фронтенде

**Проект:** StupidCMS Headless CMS  
**Дата создания:** 2025-01-14  
**Версия:** 1.0

## Обзор

План из 20 задач для реализации полного функционала управления медиафайлами на фронтенде. Основан на API endpoints, описанных в `app/Http/Controllers/Admin/V1/MediaController.php`.

### API Endpoints
- `GET /api/v1/admin/media` - список с фильтрами и пагинацией
- `POST /api/v1/admin/media` - загрузка файла
- `GET /api/v1/admin/media/{id}` - детали медиа
- `PUT /api/v1/admin/media/{id}` - обновление метаданных
- `DELETE /api/v1/admin/media/{id}` - удаление (soft delete)
- `POST /api/v1/admin/media/{id}/restore` - восстановление
- `GET /api/v1/admin/media/{id}/preview?variant={variant}` - превью
- `GET /api/v1/admin/media/{id}/download` - скачивание

### Типы медиа
- `image` - изображения (JPEG, PNG, GIF, WebP, SVG)
- `video` - видео (MP4, WebM, OGG)
- `audio` - аудио (MP3, OGG, WAV)
- `document` - документы (PDF, DOC, DOCX, XLS, XLSX и др.)

---

## Задачи

### Блок 1: Базовая инфраструктура (1-5)

#### Задача 1: Создание TypeScript типов для Media API
**Приоритет:** Высокий  
**Сложность:** Низкая  
**Зависимости:** Нет

**Описание:**
Создать типы TypeScript для всех сущностей Media API:
- `Media` - основной тип медиафайла
- `MediaKind` - тип медиа: `'image' | 'video' | 'audio' | 'document'`
- `MediaCollection` - ответ списка с пагинацией
- `MediaFilters` - параметры фильтрации
- `MediaSortField` - поля сортировки
- `MediaPreviewUrls` - URLs превью для вариантов

**Файлы:**
- `src/types/media.ts`

**Детали:**
```typescript
interface Media {
  id: string;
  kind: MediaKind;
  name: string;
  ext: string;
  mime: string;
  size_bytes: number;
  width: number | null;
  height: number | null;
  duration_ms: number | null;
  title: string | null;
  alt: string | null;
  collection: string;
  created_at: string;
  updated_at: string;
  deleted_at: string | null;
  preview_urls: Record<string, string>;
  download_url: string;
}
```

**Критерии приёмки:**
- Все типы покрывают структуру ответов API
- Типы строго типизированы (без `any`)
- Экспорт всех типов для использования в других модулях

---

#### Задача 2: Создание API клиента для Media
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задача 1

**Описание:**
Реализовать клиент для работы с Media API:
- Методы для всех endpoints
- Обработка ошибок (401, 404, 409, 422, 429)
- Типизация запросов и ответов
- Поддержка загрузки файлов (FormData)

**Файлы:**
- `src/api/media.ts` или `src/services/media.service.ts`

**Методы:**
- `listMedia(filters?: MediaFilters): Promise<MediaCollection>`
- `getMedia(id: string): Promise<Media>`
- `uploadMedia(file: File, metadata?: Partial<Media>): Promise<Media>`
- `updateMedia(id: string, metadata: Partial<Media>): Promise<Media>`
- `deleteMedia(id: string): Promise<void>`
- `restoreMedia(id: string): Promise<Media>`
- `getMediaPreview(id: string, variant: string): string`
- `getMediaDownload(id: string): string`

**Критерии приёмки:**
- Все методы покрывают API endpoints
- Корректная обработка ошибок с типизацией
- Поддержка пагинации в `listMedia`
- Валидация входных параметров

---

#### Задача 3: Создание утилит для работы с медиа
**Приоритет:** Средний  
**Сложность:** Низкая  
**Зависимости:** Задача 1

**Описание:**
Утилиты для форматирования и работы с медиафайлами:
- Форматирование размера файла (bytes → KB/MB/GB)
- Форматирование длительности (ms → mm:ss)
- Определение иконки по типу/расширению
- Валидация файлов перед загрузкой
- Генерация превью URL

**Файлы:**
- `src/utils/media.ts`

**Функции:**
- `formatFileSize(bytes: number): string`
- `formatDuration(ms: number | null): string | null`
- `getMediaIcon(kind: MediaKind, mime?: string): string`
- `validateMediaFile(file: File): { valid: boolean; error?: string }`
- `getPreviewUrl(media: Media, variant?: string): string | null`

**Критерии приёмки:**
- Корректное форматирование для всех единиц измерения
- Поддержка всех типов медиа
- Валидация MIME-типов на основе бэкенда

---

#### Задача 4: Создание компонента MediaCard
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 1, 3

**Описание:**
Компонент карточки медиафайла для отображения в списке:
- Превью (изображение/иконка)
- Название и метаданные
- Индикатор типа
- Действия (редактировать, удалить, скачать)
- Поддержка выбора (checkbox)

**Файлы:**
- `src/components/media/MediaCard.vue` (или `.tsx`, `.svelte` в зависимости от фреймворка)

**Пропсы:**
- `media: Media` - данные медиа
- `selectable?: boolean` - возможность выбора
- `selected?: boolean` - состояние выбора
- `showActions?: boolean` - показывать действия

**События:**
- `@click` - клик по карточке
- `@select` - выбор/снятие выбора
- `@edit` - редактирование
- `@delete` - удаление
- `@download` - скачивание

**Критерии приёмки:**
- Адаптивный дизайн (responsive)
- Корректное отображение всех типов медиа
- Лоадер для превью
- Обработка ошибок загрузки изображений

---

#### Задача 5: Создание хука useMedia
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 1, 2

**Описание:**
Composable/хук для управления состоянием медиа:
- Загрузка списка с фильтрами
- Загрузка деталей
- CRUD операции
- Управление пагинацией
- Обработка состояний (loading, error)

**Файлы:**
- `src/composables/useMedia.ts` (Vue) или `src/hooks/useMedia.ts` (React)

**API хука:**
```typescript
const {
  media,
  mediaList,
  loading,
  error,
  filters,
  pagination,
  loadMedia,
  loadMediaList,
  uploadMedia,
  updateMedia,
  deleteMedia,
  restoreMedia,
  setFilters,
  setPage,
} = useMedia();
```

**Критерии приёмки:**
- Реактивность состояния
- Автоматическая очистка при размонтировании
- Обработка всех состояний загрузки
- Валидация данных перед отправкой

---

### Блок 2: Компоненты отображения (6-10)

#### Задача 6: Создание компонента MediaList
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 4, 5

**Описание:**
Компонент списка медиафайлов:
- Сетка/список карточек (переключение режимов)
- Пагинация
- Индикатор загрузки
- Пустое состояние
- Поддержка множественного выбора

**Файлы:**
- `src/components/media/MediaList.vue`

**Пропсы:**
- `viewMode?: 'grid' | 'list'` - режим отображения
- `selectable?: boolean` - множественный выбор
- `filters?: MediaFilters` - начальные фильтры

**События:**
- `@select` - выбор медиа
- `@select-multiple` - выбор нескольких

**Критерии приёмки:**
- Виртуализация для больших списков (опционально)
- Infinite scroll или пагинация
- Плавная анимация загрузки
- Адаптивная сетка

---

#### Задача 7: Создание компонента MediaPreview
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 1, 3

**Описание:**
Компонент превью медиафайла:
- Изображения: с вариантами превью (thumbnail, medium, large)
- Видео: видеоплеер с controls
- Аудио: аудиоплеер с controls
- Документы: иконка + метаданные
- Zoom для изображений

**Файлы:**
- `src/components/media/MediaPreview.vue`

**Пропсы:**
- `media: Media` - данные медиа
- `variant?: string` - вариант превью (для изображений)
- `zoomable?: boolean` - возможность увеличения

**Критерии приёмки:**
- Оптимизированная загрузка изображений (lazy)
- Fallback для неудачной загрузки
- Адаптивный видеоплеер
- Доступность (accessibility)

---

#### Задача 8: Создание компонента MediaDetails
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 1, 2, 7

**Описание:**
Компонент детального просмотра медиафайла:
- Полное превью
- Все метаданные (размер, размеры, дата создания и т.д.)
- Список связанных записей (Entry)
- История изменений (опционально)
- Действия (редактировать, удалить, восстановить, скачать)

**Файлы:**
- `src/components/media/MediaDetails.vue` или `src/views/media/MediaDetails.vue`

**Пропсы:**
- `mediaId: string` - ID медиа

**Критерии приёмки:**
- Загрузка данных через API
- Обработка ошибок (404)
- Редактирование метаданных (inline или модальное окно)
- Навигация назад

---

#### Задача 9: Создание компонента MediaUploader
**Приоритет:** Высокий  
**Сложность:** Высокая  
**Зависимости:** Задачи 1, 2, 3

**Описание:**
Компонент загрузки медиафайлов:
- Drag & drop
- Множественная загрузка
- Прогресс-бар для каждого файла
- Предпросмотр перед загрузкой
- Валидация файлов
- Выбор коллекции

**Файлы:**
- `src/components/media/MediaUploader.vue`

**Пропсы:**
- `multiple?: boolean` - множественная загрузка
- `accept?: string` - допустимые типы файлов
- `maxSize?: number` - максимальный размер
- `collection?: string` - коллекция по умолчанию

**События:**
- `@upload-success` - успешная загрузка
- `@upload-error` - ошибка загрузки
- `@upload-progress` - прогресс загрузки

**Критерии приёмки:**
- Валидация до начала загрузки
- Отображение прогресса для каждого файла
- Обработка ошибок с детальными сообщениями
- Поддержка больших файлов (chunked upload, если нужно)

---

#### Задача 10: Создание компонента MediaFilters
**Приоритет:** Средний  
**Сложность:** Средняя  
**Зависимости:** Задачи 1, 5

**Описание:**
Компонент фильтрации медиа:
- Поиск по названию
- Фильтр по типу (image, video, audio, document)
- Фильтр по MIME-типу
- Фильтр по коллекции
- Управление удалёнными (with, only)
- Сортировка (поле + направление)
- Размер страницы

**Файлы:**
- `src/components/media/MediaFilters.vue`

**Пропсы:**
- `filters: MediaFilters` - текущие фильтры

**События:**
- `@filter-change` - изменение фильтров
- `@reset` - сброс фильтров

**Критерии приёмки:**
- Реактивное применение фильтров
- Сохранение фильтров в URL (query params) или localStorage
- Визуальная индикация активных фильтров
- Сброс к значениям по умолчанию

---

### Блок 3: Функциональность (11-15)

#### Задача 11: Реализация страницы Media Library
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 6, 9, 10

**Описание:**
Главная страница медиа-библиотеки:
- Интеграция всех компонентов (MediaList, MediaFilters, MediaUploader)
- Маршрутизация
- Управление состоянием
- Панель инструментов (toolbar)

**Файлы:**
- `src/views/media/MediaLibrary.vue` или `src/pages/media/index.vue`
- `src/router/media.ts` (роутинг)

**Функциональность:**
- Переключение между списком и загрузкой
- Bulk операции (удаление выбранных)
- Быстрый поиск
- Сохранение состояния фильтров

**Критерии приёмки:**
- Полная интеграция всех компонентов
- Корректная навигация
- Сохранение состояния при переходах
- Responsive дизайн

---

#### Задача 12: Реализация редактирования метаданных
**Приоритет:** Средний  
**Сложность:** Низкая  
**Зависимости:** Задачи 1, 2, 8

**Описание:**
Форма редактирования метаданных медиа:
- Поля: title, alt, collection
- Валидация
- Сохранение через API
- Обработка ошибок

**Файлы:**
- `src/components/media/MediaEditForm.vue`

**Форма:**
- Title (string, optional)
- Alt (string, optional, для изображений)
- Collection (string, required)

**Критерии приёмки:**
- Валидация полей
- Отображение ошибок валидации
- Оптимистичное обновление UI
- Обратная связь пользователю (toast/notification)

---

#### Задача 13: Реализация удаления и восстановления
**Приоритет:** Средний  
**Сложность:** Низкая  
**Зависимости:** Задачи 1, 2, 5

**Описание:**
Логика удаления и восстановления медиа:
- Подтверждение удаления
- Обработка ошибки 409 (Media in use)
- Отображение связанных записей при ошибке
- Восстановление из корзины
- Обновление списка после операций

**Файлы:**
- Интеграция в компоненты (MediaCard, MediaDetails)
- Модальное окно подтверждения

**Критерии приёмки:**
- Модальное окно с предупреждением
- Отображение связанных записей при ошибке
- Автоматическое обновление UI
- Корректная обработка всех кодов ошибок

---

#### Задача 14: Реализация скачивания медиа
**Приоритет:** Низкий  
**Сложность:** Низкая  
**Зависимости:** Задачи 1, 2

**Описание:**
Функционал скачивания медиафайлов:
- Кнопка скачивания в карточке/деталях
- Использование download_url из API
- Обработка ошибок

**Файлы:**
- Утилита или метод в useMedia

**Критерии приёмки:**
- Корректное скачивание файла
- Обработка ошибок (404, 403)
- Индикатор загрузки для больших файлов

---

#### Задача 15: Реализация поиска и фильтрации
**Приоритет:** Высокий  
**Сложность:** Средняя  
**Зависимости:** Задачи 5, 10

**Описание:**
Интеграция поиска и фильтрации:
- Debounce для поиска
- Синхронизация фильтров с URL
- Сохранение фильтров в localStorage
- Быстрые фильтры (часто используемые)

**Файлы:**
- Интеграция в MediaFilters и MediaLibrary

**Критерии приёмки:**
- Debounce 300-500ms для поиска
- URL параметры отражают фильтры
- Сохранение состояния между сессиями
- Быстрый отклик на изменения

---

### Блок 4: Дополнительные функции (16-20)

#### Задача 16: Управление коллекциями
**Приоритет:** Средний  
**Сложность:** Средняя  
**Зависимости:** Задачи 1, 2, 12

**Описание:**
Интерфейс для работы с коллекциями:
- Список коллекций
- Создание новой коллекции (если API поддерживает)
- Перемещение медиа между коллекциями
- Фильтрация по коллекции
- Группировка в UI по коллекциям (опционально)

**Файлы:**
- `src/components/media/CollectionSelector.vue`
- `src/composables/useCollections.ts` (если есть API для коллекций)

**Критерии приёмки:**
- Выбор коллекции при загрузке
- Изменение коллекции через редактирование
- Фильтрация по коллекции работает корректно
- Визуальная индикация коллекции

---

#### Задача 17: Интеграция с Entry (привязка медиа)
**Приоритет:** Средний  
**Сложность:** Высокая  
**Зависимости:** Задачи 1, 6

**Описание:**
Функционал привязки медиа к записям (Entry):
- Выбор медиа при редактировании Entry
- Отображение привязанных медиа в Entry
- Media picker компонент
- Управление порядком привязанных медиа

**Файлы:**
- `src/components/media/MediaPicker.vue`
- Интеграция в форму редактирования Entry

**Критерии приёмки:**
- Выбор нескольких медиа
- Drag & drop для изменения порядка
- Отображение превью выбранных медиа
- Сохранение связи через API Entry

---

#### Задача 18: Оптимизация производительности
**Приоритет:** Средний  
**Сложность:** Средняя  
**Зависимости:** Все предыдущие задачи

**Описание:**
Оптимизация производительности:
- Lazy loading изображений
- Виртуализация списка (для больших списков)
- Кэширование API запросов
- Debounce/throttle для поиска и фильтров
- Оптимизация перерисовок (memoization)

**Файлы:**
- Оптимизации в существующих компонентах

**Критерии приёмки:**
- Плавный скролл при 100+ элементах
- Минимальные повторные запросы к API
- Быстрый отклик UI
- Оптимизация bundle size

---

#### Задача 19: Тестирование компонентов
**Приоритет:** Высокий  
**Сложность:** Высокая  
**Зависимости:** Все предыдущие задачи

**Описание:**
Написание тестов для всех компонентов и логики:
- Unit тесты для утилит
- Unit тесты для хуков/composables
- Component тесты
- Integration тесты для API клиента
- E2E тесты для критических сценариев

**Файлы:**
- `src/utils/__tests__/media.test.ts`
- `src/composables/__tests__/useMedia.test.ts`
- `src/components/media/__tests__/MediaCard.test.ts`
- и т.д.

**Покрытие:**
- Утилиты: 100%
- Компоненты: 80%+ критического функционала
- API клиент: все методы
- Основные пользовательские сценарии

**Критерии приёмки:**
- Все тесты проходят
- Покрытие соответствует требованиям
- Тесты изолированы (mock API)
- Тесты поддерживаются и обновляются

---

#### Задача 20: Документация и финальная полировка
**Приоритет:** Средний  
**Сложность:** Низкая  
**Зависимости:** Все предыдущие задачи

**Описание:**
Финализация проекта:
- Документация компонентов (Storybook или аналог)
- Документация API клиента
- Документация хуков/composables
- Примеры использования
- Accessibility audit
- Cross-browser testing
- Performance audit

**Файлы:**
- `docs/frontend/media-components.md`
- Storybook stories (если используется)

**Критерии приёмки:**
- Вся документация актуальна
- Примеры работают
- Accessibility соответствует WCAG 2.1 AA
- Работает во всех поддерживаемых браузерах
- Производительность соответствует целям

---

## Приоритизация

### Фаза 1 (MVP): Задачи 1-6, 9, 11, 15
Базовый функционал: типы, API клиент, список, загрузка, фильтры.

### Фаза 2 (Расширение): Задачи 7-8, 12-14
Детали, редактирование, удаление, скачивание.

### Фаза 3 (Интеграция): Задачи 16-17
Коллекции и интеграция с Entry.

### Фаза 4 (Полировка): Задачи 18-20
Оптимизация, тесты, документация.

---

## Технический стек (предполагаемый)

- **Framework:** Vue 3 / React / Svelte (уточнить)
- **TypeScript:** Обязательно
- **State Management:** Pinia / Zustand / Svelte stores
- **HTTP Client:** Axios / Fetch API
- **Styling:** TailwindCSS (уже используется)
- **Testing:** Vitest / Jest
- **E2E:** Playwright / Cypress

---

## Связанные документы

- `app/Http/Controllers/Admin/V1/MediaController.php` - API контроллер
- `app/Http/Resources/MediaResource.php` - Структура ответов API
- `app/Models/Media.php` - Модель данных
- `docs/generated/http-endpoints.md` - Документация API endpoints

---

**Статус:** План создан, готов к реализации  
**Последнее обновление:** 2025-01-14
