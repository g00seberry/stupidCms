# Документация: Сервис транслитерации RU→lat (Slugify)

## Обзор

Сервис транслитерации предназначен для автоматической генерации URL-friendly slug'ов из русских и смешанных строк. Обеспечивает нормализацию, транслитерацию, очистку и уникализацию slug'ов.

## Структура решения

### 1. Интерфейсы и контракты

```
app/Support/Slug/
├── Slugifier.php              # Интерфейс транслитерации
├── UniqueSlugService.php      # Интерфейс уникализации
└── SlugOptions.php           # Класс опций конфигурации
```

**Slugifier** — основной интерфейс для преобразования строк в slug:
```php
public function slugify(string $source, ?SlugOptions $opts = null): string;
```

**UniqueSlugService** — интерфейс для обеспечения уникальности:
```php
public function ensureUnique(string $slug, callable $isTaken, int $startFrom = 2): string;
```

**SlugOptions** — настройки процесса slugify:
- `delimiter` — разделитель (по умолчанию `-`)
- `toLower` — приведение к нижнему регистру
- `asciiOnly` — только ASCII символы
- `maxLength` — максимальная длина
- `scheme` — схема транслитерации (`ru_basic`)
- `customMap` — кастомные замены
- `stopWords` — стоп-слова для удаления
- `postProcess` — функция пост-обработки

### 2. Реализации

```
app/Support/Slug/
├── DefaultSlugifier.php           # Реализация Slugifier
└── DefaultUniqueSlugService.php   # Реализация UniqueSlugService
```

### 3. Конфигурация

```
config/stupidcms.php
```

Содержит:
- Настройки по умолчанию (`slug.default`)
- Схемы транслитерации (`slug.schemes.ru_basic`)
- Маппинг русских букв → латиница
- Исключения (exceptions) для специальных случаев

### 4. Интеграция

```
app/Providers/
└── SlugServiceProvider.php    # Регистрация сервисов в DI

app/Observers/
└── EntryObserver.php          # Автоматическая генерация slug для Entry

app/Http/Controllers/Admin/
└── UtilsController.php        # API endpoint для превью slug
```

## Принцип работы

### Алгоритм slugify()

**Вход:** `"Страница"`  
**Выход:** `"stranica"`

#### Шаги обработки:

1. **Нормализация Unicode**
   - Применяется NFKD нормализация (если доступно расширение `intl`)
   - Trim пробелов
   - Приведение к нижнему регистру (`mb_strtolower`)

2. **Обработка исключений**
   - Применяются целостные замены из `exceptions` (например, `'йога' => 'yoga'`)
   - Используется regex с границами слов (`\b`)

3. **Транслитерация RU→lat**
   - Применяется маппинг из схемы `ru_basic`
   - Сортировка по длине ключей (сначала длинные комбинации)
   - Используется `strtr()` для замены

   Пример маппинга:
   ```
   'щ' => 'shch'
   'ш' => 'sh'
   'ц' => 'c'
   'й' => 'i'
   'ь' => '' (удаляется)
   ```

4. **Очистка и нормализация**
   - Удаление всех символов кроме `[a-z0-9\-_ ]`
   - Замена пробелов и `_` на разделитель (`-`)
   - Схлопывание повторяющихся разделителей
   - Trim разделителей по краям

5. **Удаление стоп-слов** (опционально)
   - Разбиение на токены по разделителю
   - Фильтрация токенов, совпадающих со стоп-словами
   - Стоп-слова транслитерируются автоматически

6. **Ограничение длины**
   - Обрезка до `maxLength`
   - Безопасная обрезка (удаление разделителей на конце)

7. **Пост-обработка** (если задана)
   - Применение кастомной функции `postProcess`

### Алгоритм ensureUnique()

**Вход:** `"stranitsa"`, `isTaken: fn($s) => true`  
**Выход:** `"stranitsa-2"`

#### Логика:

1. Проверка базового slug через `isTaken()`
2. Если занят — добавление суффикса `-2`, `-3`, ...
3. Если slug уже содержит суффикс (например, `test-5`), он заменяется
4. Ограничение попыток (до 10,000) для защиты от бесконечного цикла

## Интеграция в приложение

### 1. Автоматическая генерация в EntryObserver

```php
// При создании/обновлении Entry
EntryObserver::creating() / updating()
  ↓
ensureSlug()
  ↓
1. Если slug задан вручную → мягкая нормализация
2. Если slug пуст → генерация из title
3. Проверка уникальности:
   - В скоупе post_type
   - В reserved_routes
4. Сохранение уникального slug
```

### 2. API endpoint для превью

```
GET /api/v1/admin/utils/slugify?title=Страница&postType=page

Ответ:
{
  "base": "stranitsa",
  "unique": "stranitsa" // или "stranitsa-2" если занят
}
```

Используется в админке для показа превью slug при вводе заголовка.

## Примеры работы

| Вход | Выход | Комментарий |
|------|-------|-------------|
| `"Страница"` | `"stranica"` | Базовая транслитерация (критерий приёмки) |
| `"Страница"` (занято) | `"stranica-2"` | Дедупликация |
| `"  !!! Привет,—мир !!!  "` | `"privet-mir"` | Очистка пунктуации |
| `"Йога и чай"` | `"ioga-chai"` | Удаление стоп-слов (`и`) |
| `""` | `""` | Пустая строка |

## Расширяемость

### Кастомные схемы транслитерации

Добавление новой схемы в `config/stupidcms.php`:
```php
'schemes' => [
    'ru_basic' => [...],
    'gost' => [
        'map' => [...], // другой маппинг
        'exceptions' => [...]
    ]
]
```

### Исключения для брендов

```php
'exceptions' => [
    'йога' => 'yoga',
    'Санкт-Петербург' => 'sankt-peterburg'
]
```

### Пост-обработка

```php
$opts = new SlugOptions(
    postProcess: fn($slug, $opts) => strtoupper($slug)
);
```

## Зависимости

- **PHP 8.2+**
- **Laravel 12+**
- **Расширение `intl`** (опционально, для NFKD нормализации)
- **Расширение `mbstring`** (обязательно, для работы с UTF-8)

## Тестирование

Тесты находятся в `tests/Unit/SlugServiceTest.php`:
- Базовая транслитерация
- Дедупликация конфликтов
- Очистка пунктуации
- Стоп-слова и ограничение длины
- Граничные случаи

Запуск тестов:
```bash
php artisan test --filter=SlugServiceTest
```

