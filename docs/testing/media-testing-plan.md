# План тестирования системы мультимедиа

**Версия:** 1.0  
**Дата:** 2025-01-17  
**Проект:** stupidCms

## Обзор системы

Система мультимедиа предоставляет:

-   Загрузку и хранение файлов (изображения, видео, аудио, документы)
-   Генерацию вариантов изображений (thumbnails, resized)
-   Публичный доступ через подписанные URL
-   Админ-панель для управления медиа
-   Мягкое удаление и восстановление
-   Поиск и фильтрацию
-   Извлечение метаданных (EXIF, AV-метаданные)

---

## 1. Публичный доступ к медиа

### 1.1. GET /api/v1/media/{id}

**Описание:** Получение публичного доступа к медиа-файлу через подписанный URL.

#### Позитивные сценарии

| ID      | Сценарий                            | Ожидаемый результат                                                                                                                                                 |
| ------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PUB-001 | Запрос существующего медиа          | HTTP 200/302, файл отдан или редирект на подписанный URL                                                                                                            |
| PUB-002 | Запрос медиа с локального диска     | HTTP 200, файл отдан напрямую с правильным Content-Type                                                                                                             |
| PUB-003 | Запрос медиа с облачного диска (S3) | HTTP 302, редирект на временный подписанный URL                                                                                                                     |
| PUB-004 | Проверка TTL подписанного URL       | HTTP 200/302, заголовки `X-URL-TTL` и `X-URL-Expires-At` присутствуют, `X-URL-TTL` равен значению из `config('media.public_signed_ttl')` (по умолчанию 3600 секунд) |

#### Негативные сценарии

| ID      | Сценарий                      | Ожидаемый результат                         |
| ------- | ----------------------------- | ------------------------------------------- |
| PUB-101 | Запрос несуществующего медиа  | HTTP 404, код ошибки `NOT_FOUND`            |
| PUB-102 | Запрос мягко удалённого медиа | HTTP 404, код ошибки `NOT_FOUND`            |
| PUB-103 | Запрос с невалидным ULID      | HTTP 404, код ошибки `NOT_FOUND`            |
| PUB-104 | Файл отсутствует на диске     | HTTP 500, код ошибки `MEDIA_DOWNLOAD_ERROR` |

#### Граничные случаи

| ID      | Сценарий                           | Ожидаемый результат                                                             |
| ------- | ---------------------------------- | ------------------------------------------------------------------------------- |
| PUB-201 | Запрос после истечения TTL         | Подписанный URL недействителен, ошибка доступа (403/404 от облачного хранилища) |
| PUB-202 | Множественные запросы одного медиа | Каждый запрос генерирует новый подписанный URL                                  |

---

## 2. Админ API: Список медиа

### 2.1. GET /api/v1/admin/media

**Описание:** Получение списка медиа-файлов с фильтрацией, поиском и пагинацией.

#### Позитивные сценарии

| ID       | Сценарий                                                   | Ожидаемый результат                                               |
| -------- | ---------------------------------------------------------- | ----------------------------------------------------------------- |
| LIST-001 | Получение списка без параметров                            | HTTP 200, список медиа с пагинацией (по умолчанию 15 на страницу) |
| LIST-002 | Фильтрация по MIME-типу (`?mime=image`)                    | HTTP 200, только изображения                                      |
| LIST-003 | Фильтрация по типу (`?kind=image`)                         | HTTP 200, только изображения                                      |
| LIST-004 | Фильтрация по коллекции (`?collection=uploads`)            | HTTP 200, только медиа из указанной коллекции                     |
| LIST-005 | Поиск по названию (`?q=Hero`)                              | HTTP 200, медиа с "Hero" в title                                  |
| LIST-006 | Поиск по оригинальному имени (`?q=hero.jpg`)               | HTTP 200, медиа с "hero.jpg" в original_name                      |
| LIST-007 | Сортировка по размеру (`?sort=size_bytes&order=desc`)      | HTTP 200, медиа отсортированы по размеру (убывание)               |
| LIST-008 | Сортировка по дате создания (`?sort=created_at&order=asc`) | HTTP 200, медиа отсортированы по дате (возрастание)               |
| LIST-009 | Пагинация (`?per_page=10&page=2`)                          | HTTP 200, вторая страница с 10 элементами                         |
| LIST-010 | Включение удалённых (`?deleted=with`)                      | HTTP 200, все медиа включая удалённые                             |
| LIST-011 | Только удалённые (`?deleted=only`)                         | HTTP 200, только удалённые медиа                                  |
| LIST-012 | Комбинация фильтров                                        | HTTP 200, результат соответствует всем фильтрам                   |

#### Негативные сценарии

| ID       | Сценарий                              | Ожидаемый результат                 |
| -------- | ------------------------------------- | ----------------------------------- |
| LIST-101 | Запрос без аутентификации             | HTTP 401, код ошибки `UNAUTHORIZED` |
| LIST-102 | Запрос с невалидным `per_page` (>100) | HTTP 422, валидационная ошибка      |
| LIST-103 | Запрос с невалидным `per_page` (<1)   | HTTP 422, валидационная ошибка      |
| LIST-104 | Запрос с невалидным `sort`            | HTTP 422, валидационная ошибка      |
| LIST-105 | Запрос с невалидным `order`           | HTTP 422, валидационная ошибка      |
| LIST-106 | Запрос с невалидным `deleted`         | HTTP 422, валидационная ошибка      |

#### Граничные случаи

| ID       | Сценарий                               | Ожидаемый результат                    |
| -------- | -------------------------------------- | -------------------------------------- |
| LIST-201 | Пустой список медиа                    | HTTP 200, `data: []`, `total: 0`       |
| LIST-202 | Поиск без результатов                  | HTTP 200, `data: []`, `total: 0`       |
| LIST-203 | Запрос страницы за пределами диапазона | HTTP 200, `data: []`                   |
| LIST-204 | Максимальный `per_page` (100)          | HTTP 200, до 100 элементов на странице |

---

## 3. Админ API: Загрузка медиа

### 3.1. POST /api/v1/admin/media

**Описание:** Загрузка нового медиа-файла.

#### Позитивные сценарии

| ID         | Сценарий                                 | Ожидаемый результат                                        |
| ---------- | ---------------------------------------- | ---------------------------------------------------------- |
| UPLOAD-001 | Загрузка изображения JPEG                | HTTP 201, медиа создано, метаданные извлечены              |
| UPLOAD-002 | Загрузка изображения PNG                 | HTTP 201, медиа создано                                    |
| UPLOAD-003 | Загрузка изображения WebP                | HTTP 201, медиа создано                                    |
| UPLOAD-004 | Загрузка видео MP4                       | HTTP 201, медиа создано, длительность извлечена            |
| UPLOAD-005 | Загрузка аудио MP3                       | HTTP 201, медиа создано                                    |
| UPLOAD-006 | Загрузка PDF документа                   | HTTP 201, медиа создано                                    |
| UPLOAD-007 | Загрузка с указанием `title`             | HTTP 201, `title` сохранён                                 |
| UPLOAD-008 | Загрузка с указанием `alt`               | HTTP 201, `alt` сохранён                                   |
| UPLOAD-009 | Загрузка с указанием `collection`        | HTTP 201, `collection` сохранена, файл на правильном диске |
| UPLOAD-010 | Загрузка дубликата (по checksum)         | HTTP 200, возвращён существующий медиа                     |
| UPLOAD-011 | Проверка извлечения EXIF                 | HTTP 201, `exif_json` заполнен для изображений             |
| UPLOAD-012 | Проверка извлечения размеров изображения | HTTP 201, `width` и `height` заполнены                     |
| UPLOAD-013 | Проверка извлечения длительности видео   | HTTP 201, `duration_ms` заполнен                           |

#### Негативные сценарии

| ID         | Сценарий                                    | Ожидаемый результат                                          |
| ---------- | ------------------------------------------- | ------------------------------------------------------------ |
| UPLOAD-101 | Загрузка без файла                          | HTTP 422, код ошибки `VALIDATION_ERROR`                      |
| UPLOAD-102 | Загрузка неразрешённого MIME-типа           | HTTP 422, валидационная ошибка                               |
| UPLOAD-103 | Загрузка файла превышающего `max_upload_mb` | HTTP 422, валидационная ошибка                               |
| UPLOAD-104 | Загрузка без аутентификации                 | HTTP 401, код ошибки `UNAUTHORIZED`                          |
| UPLOAD-105 | Загрузка без прав `create`                  | HTTP 403, код ошибки `FORBIDDEN`                             |
| UPLOAD-106 | Превышение rate limit (20/мин)              | HTTP 429, код ошибки `RATE_LIMIT_EXCEEDED`                   |
| UPLOAD-107 | Загрузка повреждённого файла                | HTTP 422/500, ошибка валидации или обработки                 |
| UPLOAD-108 | Загрузка с невалидным `collection`          | HTTP 422, валидационная ошибка (если есть правила коллекции) |

#### Граничные случаи

| ID         | Сценарий                                         | Ожидаемый результат                   |
| ---------- | ------------------------------------------------ | ------------------------------------- |
| UPLOAD-201 | Загрузка файла размером ровно `max_upload_mb`    | HTTP 201, файл принят                 |
| UPLOAD-202 | Загрузка файла размером `max_upload_mb + 1 байт` | HTTP 422, валидационная ошибка        |
| UPLOAD-203 | Загрузка очень большого изображения              | HTTP 201, размеры извлечены корректно |
| UPLOAD-204 | Загрузка файла с очень длинным именем            | HTTP 201, имя обрезано или сохранено  |
| UPLOAD-205 | Загрузка файла с кириллицей в имени              | HTTP 201, имя сохранено корректно     |

---

## 4. Админ API: Просмотр медиа

### 4.1. GET /api/v1/admin/media/{id}

**Описание:** Получение информации о конкретном медиа-файле.

#### Позитивные сценарии

| ID       | Сценарий                                | Ожидаемый результат                                                                                                                                                                                                   |
| -------- | --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| SHOW-001 | Просмотр существующего медиа            | HTTP 200, полная информация о медиа                                                                                                                                                                                   |
| SHOW-002 | Просмотр мягко удалённого медиа         | HTTP 200, информация включает `deleted_at`                                                                                                                                                                            |
| SHOW-003 | Проверка структуры ответа               | HTTP 200, все поля присутствуют: `id`, `kind`, `name`, `mime`, `size_bytes`, `width`, `height`, `duration_ms`, `title`, `alt`, `collection`, `created_at`, `updated_at`, `deleted_at`, `preview_urls`, `download_url` |
| SHOW-004 | Проверка `preview_urls` для изображений | HTTP 200, `preview_urls` содержит варианты (thumbnail, medium)                                                                                                                                                        |
| SHOW-005 | Проверка `download_url`                 | HTTP 200, `download_url` указывает на правильный endpoint                                                                                                                                                             |

#### Негативные сценарии

| ID       | Сценарий                       | Ожидаемый результат                 |
| -------- | ------------------------------ | ----------------------------------- |
| SHOW-101 | Просмотр несуществующего медиа | HTTP 404, код ошибки `NOT_FOUND`    |
| SHOW-102 | Запрос без аутентификации      | HTTP 401, код ошибки `UNAUTHORIZED` |
| SHOW-103 | Запрос без прав `view`         | HTTP 403, код ошибки `FORBIDDEN`    |
| SHOW-104 | Запрос с невалидным ULID       | HTTP 404, код ошибки `NOT_FOUND`    |

---

## 5. Админ API: Обновление медиа

### 5.1. PUT /api/v1/admin/media/{id}

**Описание:** Обновление метаданных медиа-файла.

#### Позитивные сценарии

| ID         | Сценарий                           | Ожидаемый результат                              |
| ---------- | ---------------------------------- | ------------------------------------------------ |
| UPDATE-001 | Обновление `title`                 | HTTP 200, `title` обновлён, `updated_at` изменён |
| UPDATE-002 | Обновление `alt`                   | HTTP 200, `alt` обновлён                         |
| UPDATE-003 | Обновление `collection`            | HTTP 200, `collection` обновлена                 |
| UPDATE-004 | Обновление всех полей одновременно | HTTP 200, все поля обновлены                     |
| UPDATE-005 | Обновление мягко удалённого медиа  | HTTP 200, метаданные обновлены                   |

#### Негативные сценарии

| ID         | Сценарий                             | Ожидаемый результат                                |
| ---------- | ------------------------------------ | -------------------------------------------------- |
| UPDATE-101 | Обновление несуществующего медиа     | HTTP 404, код ошибки `NOT_FOUND`                   |
| UPDATE-102 | Запрос без аутентификации            | HTTP 401, код ошибки `UNAUTHORIZED`                |
| UPDATE-103 | Запрос без прав `update`             | HTTP 403, код ошибки `FORBIDDEN`                   |
| UPDATE-104 | Обновление с невалидным `collection` | HTTP 422, валидационная ошибка (если есть правила) |

#### Граничные случаи

| ID         | Сценарий                           | Ожидаемый результат                                    |
| ---------- | ---------------------------------- | ------------------------------------------------------ |
| UPDATE-201 | Обновление с пустым `title`        | HTTP 200, `title` установлен в `null`                  |
| UPDATE-202 | Обновление с очень длинным `title` | HTTP 422, валидационная ошибка (если есть ограничение) |

---

## 6. Админ API: Массовое удаление

### 6.1. DELETE /api/v1/admin/media/bulk

**Описание:** Массовое мягкое удаление медиа-файлов.

#### Позитивные сценарии

| ID           | Сценарий                        | Ожидаемый результат                                     |
| ------------ | ------------------------------- | ------------------------------------------------------- |
| BULK-DEL-001 | Удаление одного медиа           | HTTP 204, медиа мягко удалено (`deleted_at` установлен) |
| BULK-DEL-002 | Удаление нескольких медиа       | HTTP 204, все медиа мягко удалены                       |
| BULK-DEL-003 | Удаление уже удалённого медиа   | HTTP 204, операция идемпотентна                         |
| BULK-DEL-004 | Проверка события `MediaDeleted` | HTTP 204, событие отправлено для каждого медиа          |

#### Негативные сценарии

| ID           | Сценарий                        | Ожидаемый результат                         |
| ------------ | ------------------------------- | ------------------------------------------- |
| BULK-DEL-101 | Удаление без аутентификации     | HTTP 401, код ошибки `UNAUTHORIZED`         |
| BULK-DEL-102 | Удаление без прав `delete`      | HTTP 403, код ошибки `FORBIDDEN`            |
| BULK-DEL-103 | Пустой массив `ids`             | HTTP 422, валидационная ошибка              |
| BULK-DEL-104 | Массив `ids` с >100 элементами  | HTTP 422, валидационная ошибка              |
| BULK-DEL-105 | Массив `ids` с невалидными ULID | HTTP 422, валидационная ошибка              |
| BULK-DEL-106 | Удаление несуществующего медиа  | HTTP 204, операция идемпотентна (не падает) |

#### Граничные случаи

| ID           | Сценарий                                     | Ожидаемый результат            |
| ------------ | -------------------------------------------- | ------------------------------ |
| BULK-DEL-201 | Удаление 100 медиа (максимум)                | HTTP 204, все удалены          |
| BULK-DEL-202 | Частичное удаление (некоторые не существуют) | HTTP 204, существующие удалены |

---

## 7. Админ API: Массовое восстановление

### 7.1. POST /api/v1/admin/media/bulk/restore

**Описание:** Массовое восстановление мягко удалённых медиа-файлов.

#### Позитивные сценарии

| ID               | Сценарий                           | Ожидаемый результат                                 |
| ---------------- | ---------------------------------- | --------------------------------------------------- |
| BULK-RESTORE-001 | Восстановление одного медиа        | HTTP 200, медиа восстановлено (`deleted_at = null`) |
| BULK-RESTORE-002 | Восстановление нескольких медиа    | HTTP 200, все медиа восстановлены, возвращён массив |
| BULK-RESTORE-003 | Восстановление не удалённого медиа | HTTP 200, медиа остаётся без изменений              |

#### Негативные сценарии

| ID               | Сценарий                          | Ожидаемый результат                 |
| ---------------- | --------------------------------- | ----------------------------------- |
| BULK-RESTORE-101 | Восстановление без аутентификации | HTTP 401, код ошибки `UNAUTHORIZED` |
| BULK-RESTORE-102 | Восстановление без прав `restore` | HTTP 403, код ошибки `FORBIDDEN`    |
| BULK-RESTORE-103 | Пустой массив `ids`               | HTTP 422, валидационная ошибка      |
| BULK-RESTORE-104 | Массив `ids` с >100 элементами    | HTTP 422, валидационная ошибка      |

#### Граничные случаи

| ID               | Сценарий                             | Ожидаемый результат                                       |
| ---------------- | ------------------------------------ | --------------------------------------------------------- |
| BULK-RESTORE-201 | Восстановление несуществующего медиа | HTTP 200, медиа не включено в ответ (только существующие) |

---

## 8. Админ API: Массовое окончательное удаление

### 8.1. DELETE /api/v1/admin/media/bulk/force

**Описание:** Массовое окончательное удаление медиа-файлов (необратимо).

#### Позитивные сценарии

| ID                 | Сценарий                                | Ожидаемый результат                                 |
| ------------------ | --------------------------------------- | --------------------------------------------------- |
| BULK-FORCE-DEL-001 | Окончательное удаление одного медиа     | HTTP 204, файл удалён с диска, запись удалена из БД |
| BULK-FORCE-DEL-002 | Окончательное удаление нескольких медиа | HTTP 204, все файлы и записи удалены                |
| BULK-FORCE-DEL-003 | Удаление вариантов вместе с медиа       | HTTP 204, все варианты также удалены                |
| BULK-FORCE-DEL-004 | Удаление мягко удалённого медиа         | HTTP 204, медиа окончательно удалено                |

#### Негативные сценарии

| ID                 | Сценарий                        | Ожидаемый результат                 |
| ------------------ | ------------------------------- | ----------------------------------- |
| BULK-FORCE-DEL-101 | Удаление без аутентификации     | HTTP 401, код ошибки `UNAUTHORIZED` |
| BULK-FORCE-DEL-102 | Удаление без прав `forceDelete` | HTTP 403, код ошибки `FORBIDDEN`    |
| BULK-FORCE-DEL-103 | Пустой массив `ids`             | HTTP 422, валидационная ошибка      |
| BULK-FORCE-DEL-104 | Массив `ids` с >100 элементами  | HTTP 422, валидационная ошибка      |

#### Граничные случаи

| ID                 | Сценарий                                       | Ожидаемый результат                         |
| ------------------ | ---------------------------------------------- | ------------------------------------------- |
| BULK-FORCE-DEL-201 | Удаление медиа с отсутствующим файлом на диске | HTTP 204, запись удалена из БД (не падает)  |
| BULK-FORCE-DEL-202 | Ошибка при удалении файла с диска              | HTTP 500, код ошибки или логирование ошибки |

---

## 9. Админ API: Предпросмотр вариантов

### 9.1. GET /api/v1/admin/media/{id}/preview

**Описание:** Получение варианта изображения (thumbnail, medium и т.д.).

#### Позитивные сценарии

| ID          | Сценарий                                | Ожидаемый результат                                                                 |
| ----------- | --------------------------------------- | ----------------------------------------------------------------------------------- |
| PREVIEW-001 | Предпросмотр варианта `thumbnail`       | HTTP 200/302, файл варианта отдан                                                   |
| PREVIEW-002 | Предпросмотр варианта `medium`          | HTTP 200/302, файл варианта отдан                                                   |
| PREVIEW-003 | Автоматическая генерация варианта       | HTTP 200/302, вариант создан и отдан                                                |
| PREVIEW-004 | Повторный запрос существующего варианта | HTTP 200/302, существующий вариант отдан (не генерируется заново)                   |
| PREVIEW-005 | Проверка размеров варианта              | HTTP 200, размеры соответствуют конфигурации (`config('media.variants.thumbnail')`) |

#### Негативные сценарии

| ID          | Сценарий                                 | Ожидаемый результат                        |
| ----------- | ---------------------------------------- | ------------------------------------------ |
| PREVIEW-101 | Предпросмотр несуществующего медиа       | HTTP 404, код ошибки `NOT_FOUND`           |
| PREVIEW-102 | Предпросмотр несуществующего варианта    | HTTP 422, код ошибки `VALIDATION_ERROR`    |
| PREVIEW-103 | Предпросмотр варианта для не-изображения | HTTP 422, код ошибки `VALIDATION_ERROR`    |
| PREVIEW-104 | Запрос без аутентификации                | HTTP 401, код ошибки `UNAUTHORIZED`        |
| PREVIEW-105 | Запрос без прав `view`                   | HTTP 403, код ошибки `FORBIDDEN`           |
| PREVIEW-106 | Ошибка генерации варианта                | HTTP 500, код ошибки `MEDIA_VARIANT_ERROR` |

#### Граничные случаи

| ID          | Сценарий                                | Ожидаемый результат                              |
| ----------- | --------------------------------------- | ------------------------------------------------ |
| PREVIEW-201 | Предпросмотр очень большого изображения | HTTP 200, вариант создан с правильными размерами |
| PREVIEW-202 | Предпросмотр повреждённого изображения  | HTTP 500, код ошибки `MEDIA_VARIANT_ERROR`       |

---

## 10. Админ API: Скачивание оригинала

### 10.1. GET /api/v1/admin/media/{id}/download

**Описание:** Получение временной ссылки на оригинальный файл.

#### Позитивные сценарии

| ID           | Сценарий                          | Ожидаемый результат                                                |
| ------------ | --------------------------------- | ------------------------------------------------------------------ |
| DOWNLOAD-001 | Скачивание существующего медиа    | HTTP 200/302, файл отдан или редирект на подписанный URL           |
| DOWNLOAD-002 | Скачивание с локального диска     | HTTP 200, файл отдан напрямую                                      |
| DOWNLOAD-003 | Скачивание с облачного диска      | HTTP 302, редирект на подписанный URL                              |
| DOWNLOAD-004 | Проверка TTL подписанного URL     | URL действителен в течение времени из `config('media.signed_ttl')` |
| DOWNLOAD-005 | Скачивание мягко удалённого медиа | HTTP 200/302, файл доступен                                        |

#### Негативные сценарии

| ID           | Сценарий                         | Ожидаемый результат                         |
| ------------ | -------------------------------- | ------------------------------------------- |
| DOWNLOAD-101 | Скачивание несуществующего медиа | HTTP 404, код ошибки `NOT_FOUND`            |
| DOWNLOAD-102 | Запрос без аутентификации        | HTTP 401, код ошибки `UNAUTHORIZED`         |
| DOWNLOAD-103 | Запрос без прав `view`           | HTTP 403, код ошибки `FORBIDDEN`            |
| DOWNLOAD-104 | Файл отсутствует на диске        | HTTP 500, код ошибки `MEDIA_DOWNLOAD_ERROR` |

---

## 11. Интеграционное тестирование

### 11.1. Сценарии взаимодействия компонентов

| ID      | Сценарий                                               | Ожидаемый результат                                            |
| ------- | ------------------------------------------------------ | -------------------------------------------------------------- |
| INT-001 | Загрузка → Просмотр → Обновление → Удаление            | Все операции выполняются последовательно без ошибок            |
| INT-002 | Загрузка → Генерация вариантов → Предпросмотр          | Варианты генерируются и доступны для предпросмотра             |
| INT-003 | Загрузка → Мягкое удаление → Восстановление → Просмотр | Медиа восстанавливается и доступно                             |
| INT-004 | Загрузка → Мягкое удаление → Окончательное удаление    | Медиа окончательно удалено, недоступно для восстановления      |
| INT-005 | Загрузка дубликата → Проверка дедупликации             | Возвращён существующий медиа, новый файл не создан             |
| INT-006 | Загрузка → Публичный доступ                            | Публичный URL работает для неаутентифицированных пользователей |

---

## 12. Производительность и нагрузочное тестирование

### 12.1. Нагрузочные сценарии

| ID       | Сценарий                                           | Ожидаемый результат                                |
| -------- | -------------------------------------------------- | -------------------------------------------------- |
| PERF-001 | Загрузка 100 файлов подряд                         | Все файлы загружены, время ответа приемлемое       |
| PERF-002 | Список медиа с большим количеством записей (1000+) | Пагинация работает корректно, время ответа < 1 сек |
| PERF-003 | Поиск по большому количеству медиа                 | Результаты возвращены за приемлемое время          |
| PERF-004 | Массовое удаление 100 медиа                        | Операция завершена за приемлемое время             |
| PERF-005 | Генерация вариантов для большого изображения       | Вариант создан за приемлемое время                 |

---

## 13. Безопасность

### 13.1. Сценарии безопасности

| ID      | Сценарий                                                          | Ожидаемый результат                           |
| ------- | ----------------------------------------------------------------- | --------------------------------------------- |
| SEC-001 | Попытка доступа к медиа другого пользователя (если есть изоляция) | HTTP 403 или медиа недоступно                 |
| SEC-002 | Попытка загрузки исполняемого файла                               | HTTP 422, файл отклонён                       |
| SEC-003 | Попытка загрузки файла с подделанным MIME-типом                   | HTTP 422, валидация по содержимому            |
| SEC-004 | SQL-инъекция в параметрах поиска                                  | Запрос безопасен, SQL-инъекция не выполняется |
| SEC-005 | XSS в метаданных (title, alt)                                     | Данные экранированы в ответах API             |
| SEC-006 | Path traversal в имени файла                                      | Имя файла санитизировано                      |
| SEC-007 | Проверка rate limiting                                            | Превышение лимита возвращает HTTP 429         |

---

## 14. Тестирование метаданных

### 14.1. Извлечение метаданных

| ID       | Сценарий                           | Ожидаемый результат                                |
| -------- | ---------------------------------- | -------------------------------------------------- |
| META-001 | Извлечение EXIF из JPEG            | `exif_json` заполнен корректными данными           |
| META-002 | Извлечение размеров изображения    | `width` и `height` соответствуют реальным размерам |
| META-003 | Извлечение длительности видео      | `duration_ms` соответствует реальной длительности  |
| META-004 | Извлечение метаданных аудио        | Метаданные извлечены (если поддерживается)         |
| META-005 | Создание записи в `media_metadata` | Запись создана для AV-файлов (если включено)       |

---

## 15. Тестирование коллекций

### 15.1. Работа с коллекциями

| ID       | Сценарий                              | Ожидаемый результат                                  |
| -------- | ------------------------------------- | ---------------------------------------------------- |
| COLL-001 | Загрузка в коллекцию                  | Медиа сохранено с указанной коллекцией               |
| COLL-002 | Фильтрация по коллекции               | Возвращаются только медиа из указанной коллекции     |
| COLL-003 | Маршрутизация по дискам для коллекций | Файл сохранён на правильном диске (если настроено)   |
| COLL-004 | Правила валидации для коллекций       | Применяются правила из `config('media.collections')` |

---

## 16. Тестирование вариантов изображений

### 16.1. Генерация вариантов

| ID      | Сценарий                                             | Ожидаемый результат                             |
| ------- | ---------------------------------------------------- | ----------------------------------------------- |
| VAR-001 | Автоматическая генерация варианта при первом запросе | Вариант создан и сохранён                       |
| VAR-002 | Повторное использование существующего варианта       | Вариант не генерируется заново                  |
| VAR-003 | Проверка размеров варианта `thumbnail`               | Размеры соответствуют конфигурации (max 320px)  |
| VAR-004 | Проверка размеров варианта `medium`                  | Размеры соответствуют конфигурации (max 1024px) |
| VAR-005 | Генерация варианта для очень маленького изображения  | Вариант создан (изображение не увеличено)       |
| VAR-006 | Генерация варианта для очень большого изображения    | Вариант создан с правильными размерами          |

---

## 17. Чек-лист для тестировщика

### Перед началом тестирования

-   [ ] Ознакомиться с документацией API (Scribe)
-   [ ] Подготовить тестовые файлы разных типов (JPEG, PNG, WebP, MP4, MP3, PDF)
-   [ ] Настроить тестовое окружение (локальный и облачный диск)
-   [ ] Получить токены доступа для разных ролей пользователей

### Во время тестирования

-   [ ] Проверять все HTTP статус-коды
-   [ ] Проверять структуру JSON-ответов
-   [ ] Проверять валидационные ошибки
-   [ ] Проверять права доступа (authorization)
-   [ ] Проверять rate limiting
-   [ ] Проверять работу с мягко удалёнными записями
-   [ ] Проверять пагинацию
-   [ ] Проверять фильтрацию и поиск
-   [ ] Проверять генерацию вариантов
-   [ ] Проверять подписанные URL

### После тестирования

-   [ ] Задокументировать найденные баги
-   [ ] Проверить логи на наличие ошибок
-   [ ] Проверить состояние БД после операций
-   [ ] Проверить состояние файлов на дисках

---

## 18. Известные ограничения

1. **Варианты изображений** генерируются только для изображений (не для видео/аудио)
2. **EXIF метаданные** извлекаются только для изображений
3. **AV-метаданные** требуют установки внешних утилит (ffprobe, mediainfo, exiftool)
4. **Подписанные URL** имеют ограниченное время жизни (TTL)
5. **Rate limiting** на загрузку: 20 запросов в минуту

---

## 19. Ссылки на документацию

-   API документация: `/docs/api` (Scribe)
-   Конфигурация: `config/media.php`
-   Модели: `app/Models/Media.php`, `app/Models/MediaVariant.php`, `app/Models/MediaMetadata.php`
-   Контроллеры: `app/Http/Controllers/PublicMediaController.php`, `app/Http/Controllers/Admin/V1/MediaController.php`, `app/Http/Controllers/Admin/V1/MediaPreviewController.php`

---

**Примечание:** Этот план тестирования должен регулярно обновляться при добавлении новых функций или изменении существующих.
